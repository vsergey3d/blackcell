var B={};B.Std={},B.Std.freeObject=function(a){var b;for(b in a)a.hasOwnProperty(b)&&(a[b]=null)},B.Std.removeUnordered=function(a,b){var c=a.length,d=a[b];return!c||b>=c?null:(c>1&&(a[b]=a[c-1],a[b]._id=b),a.length-=1,d)},B.Std.Event=function(a,b,c){this.type=b,this.caster=a,this.receiver=null,this.data=c||null,this.stopped=!1,this.omitted=!1},B.Std.ListenableProto=function(){var a=B.Std.Event;this.makeEvent=function(b,c){return new a(this,b,c)},this.bubbling=function(a){return 0===arguments.length?this._bubbling:(this._bubbling=a,this)},this.on=function(a,b,c){var d,e=this;return a.split(" ").forEach(function(a){d=e._handlers[a],d||(d=[],e._handlers[a]=d),b._eventIndex=d.push({handler:b,filter:c})}),this},this.off=function(a,b,c){var d,e,f,g=this;return a.split(" ").forEach(function(a){if(f=g._handlers[a],!f)return this;for(d=f.length-1;d>=0;d-=1)if(e=f[d],e.handler===b&&(!e.filter||e.filter===c)){f.splice(d,1);break}}),this},this.trigger=function(b,c){return"string"==typeof b&&(b=new a(this,b,c)),this._trigger(b),this},this._trigger=function(a){var b,c,d,e=this._handlers[a.type],f=this._parent;if(a.receiver=this,a.stopped=!this._bubbling,a.omitted=!1,e)for(b=e.length-1;b>=0&&(c=e[b],d=c.filter,(!d||d(a))&&c.handler(a),a.omitted!==!0);b-=1);f&&a.stopped!==!0&&f._trigger(a)}},B.Std.Listenable=function(a){this._parent=a||null,this._handlers={},this._bubbling=!1},B.Std.Listenable.prototype=new B.Std.ListenableProto,B.Math={},B.Math.Type={POINT:1,PLANE:2,RAY:3,SEGMENT:4,TRIANGLE:5,AABOX:6,SPHERE:7},B.Math.EPSILON=1e-7,B.Math.equal=function(){var a=B.Math.EPSILON,b=Math.abs;return function(c,d){return b(c-d)<a}}(),B.Math.Relation={INTERSECT:1,INSIDE:2,OUTSIDE:4},B.Math.testRelationByDistance=function(a,b){var c=B.Math,d=c.Relation;return b=b||d.INTERSECT,Math.abs(a)<c.EPSILON?!!(b&d.INTERSECT):!!(b&d.OUTSIDE)},B.Math.degrees=function(a){return a*(180/Math.PI)},B.Math.radians=function(a){return a*(Math.PI/180)},B.Math.makeColor=function(a,b,c,d){return new B.Math.Color(a,b,c,d)},B.Math.makeVector2=function(a,b){return new B.Math.Vector2(a,b)},B.Math.makeVector3=function(a,b,c){return new B.Math.Vector3(a,b,c)},B.Math.makeVector4=function(a,b,c,d){return new B.Math.Vector4(a,b,c,d)},B.Math.makeMatrix3=function(a,b,c,d,e,f,g,h,i){return 0===arguments.length?new B.Math.Matrix3:new B.Math.Matrix3(a,b,c,d,e,f,g,h,i)},B.Math.makeMatrix4=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){return 0===arguments.length?new B.Math.Matrix4:new B.Math.Matrix4(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p)},B.Math.makeQuaternion=function(a,b,c,d){return new B.Math.Quaternion(a,b,c,d)},B.Math.makeAngles=function(a,b,c){return new B.Math.Angles(a,b,c)},B.Math.makePlane=function(a,b){return new B.Math.Plane(a,b)},B.Math.makeRay=function(a,b){return new B.Math.Ray(a,b)},B.Math.makeSegment=function(a,b){return new B.Math.Segment(a,b)},B.Math.makeTriangle=function(a,b,c){return new B.Math.Triangle(a,b,c)},B.Math.makeAABox=function(a,b){return new B.Math.AABox(a,b)},B.Math.makeSphere=function(a,b){return new B.Math.Sphere(a,b)},B.Math.makeFrustum=function(a,b,c,d,e,f){return new B.Math.Frustum(a,b,c,d,e,f)},B.Math.ColorProto=function(){var a=B.Math,b=a.equal,c=Math.min,d=Math.max;this.copy=function(a){return this.r=a.r,this.g=a.g,this.b=a.b,this.a=a.a,this},this.clone=function(){return new a.Color(this.r,this.g,this.b,this.a)},this.set=function(a,b,c,d){return this.r=a,this.g=b,this.b=c,this.a=d,this.clamp()},this.get=function(a){switch(a){case 0:return this.r;case 1:return this.g;case 2:return this.b;case 3:return this.a;default:throw new Error("Color index is out of range")}},this.setHex=function(a){var b=Math.floor(a);return this.r=(b>>16&255)/255,this.g=(b>>8&255)/255,this.b=(255&b)/255,this},this.getHex=function(){return 255*this.r<<16^255*this.g<<8^255*this.b},this.fromArray=function(a,b){return b=b||0,this.r=a[b],this.g=a[b+1],this.b=a[b+2],this.a=a[b+3],this.clamp(),b+4},this.toArray=function(a,b){return b=b||0,a[b]=this.r,a[b+1]=this.g,a[b+2]=this.b,a[b+3]=this.a,b+4},this.clamp=function(){return this.r=d(c(this.r,1),0),this.g=d(c(this.g,1),0),this.b=d(c(this.b,1),0),this.a=d(c(this.a,1),0),this},this.add=function(a){return"number"==typeof a?(this.r+=a,this.g+=a,this.b+=a,this.a+=a):(this.r+=a.r,this.g+=a.g,this.b+=a.b,this.a+=a.a),this.clamp()},this.addColors=function(a,b){return this.r=a.r+b.r,this.g=a.g+b.g,this.b=a.b+b.b,this.a=a.a+b.a,this.clamp()},this.sub=function(a){return"number"==typeof a?(this.r-=a,this.g-=a,this.b-=a,this.a-=a):(this.r-=a.r,this.g-=a.g,this.b-=a.b,this.a-=a.a),this.clamp()},this.subColors=function(a,b){return this.r=a.r-b.r,this.g=a.g-b.g,this.b=a.b-b.b,this.a=a.a-b.a,this.clamp()},this.mul=function(a){return"number"==typeof a?(this.r*=a,this.g*=a,this.b*=a,this.a*=a):(this.r*=a.r,this.g*=a.g,this.b*=a.b,this.a*=a.a),this.clamp()},this.mulColors=function(a,b){return this.r=a.r*b.r,this.g=a.g*b.g,this.b=a.b*b.b,this.a=a.a*b.a,this.clamp()},this.equal=function(a){return b(a.r,this.r)&&b(a.g,this.g)&&b(a.b,this.b)&&b(a.a,this.a)}},B.Math.Color=function(a,b,c,d){this.r=a||0,this.g=b||0,this.b=c||0,this.a=void 0===d?1:d,this.clamp()},B.Math.Color.prototype=new B.Math.ColorProto,B.Math.Color.WHITE=B.Math.makeColor(1,1,1,1),B.Math.Color.GRAY=B.Math.makeColor(.5,.5,.5,1),B.Math.Color.BLACK=B.Math.makeColor(0,0,0,1),B.Math.Color.RED=B.Math.makeColor(1,0,0,1),B.Math.Color.GREEN=B.Math.makeColor(0,1,0,1),B.Math.Color.BLUE=B.Math.makeColor(0,0,1,1),B.Math.Vector2Proto=function(){var a=B.Math,b=a.EPSILON,c=a.equal,d=Math.abs,e=Math.sqrt,f=Math.min,g=Math.max;this.clone=function(){return a.makeVector2(this.x,this.y)},this.copy=function(a){return this.x=a.x,this.y=a.y,this},this.set=function(a,b){return this.x=a,this.y=b,this},this.get=function(a){switch(a){case 0:return this.x;case 1:return this.y;default:throw new Error("Vector2 index is out of range")}},this.fromArray=function(a,b){return b=b||0,this.x=a[b],this.y=a[b+1],b+2},this.toArray=function(a,b){return b=b||0,a[b]=this.x,a[b+1]=this.y,b+2},this.length=function(){var a=this.x,b=this.y;return Math.sqrt(a*a+b*b)},this.lengthSq=function(){var a=this.x,b=this.y;return a*a+b*b},this.normalize=function(){var a=this.lengthSq();return a>0&&d(1-a)>b&&this.mul(1/e(a)),this},this.negate=function(){return this.x*=-1,this.y*=-1,this},this.clamp=function(a,b){return a=a||0,b=b||1,this.x=g(f(this.x,b),a),this.y=g(f(this.y,b),a),this},this.add=function(a){return"number"==typeof a?(this.x+=a,this.y+=a):(this.x+=a.x,this.y+=a.y),this},this.addVectors=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this},this.sub=function(a){return"number"==typeof a?(this.x-=a,this.y-=a):(this.x-=a.x,this.y-=a.y),this},this.subVectors=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},this.mul=function(a){return"number"==typeof a?(this.x*=a,this.y*=a):(this.x*=a.x,this.y*=a.y),this},this.mulVectors=function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this},this.div=function(a){return"number"==typeof a?(this.x/=a,this.y/=a):(this.x/=a.x,this.y/=a.y),this},this.divVectors=function(a,b){return this.x=a.x/b.x,this.y=a.y/b.y,this},this.dot=function(a){return this.x*a.x+this.y*a.y},this.angleTo=function(a){var b=this.dot(a)/(this.length()*a.length());return Math.acos(f(g(b,-1),1))},this.distanceTo=function(a){return Math.sqrt(this.distanceToSq(a))},this.distanceToSq=function(a){var b=this.x-a.x,c=this.y-a.y;return b*b+c*c},this.equal=function(a){return c(a.x,this.x)&&c(a.y,this.y)}},B.Math.Vector2=function(a,b){this.x=a||0,this.y=b||0},B.Math.Vector2.prototype=new B.Math.Vector2Proto,B.Math.Vector2.ZERO=B.Math.makeVector2(0,0),B.Math.Vector2.INF=B.Math.makeVector2(1/0,1/0),B.Math.Vector2.N_INF=B.Math.makeVector2(-1/0,-1/0),B.Math.Vector2.X=B.Math.makeVector2(1,0),B.Math.Vector2.Y=B.Math.makeVector2(0,1),B.Math.Vector2.N_X=B.Math.makeVector2(-1,0),B.Math.Vector2.N_Y=B.Math.makeVector2(0,-1),B.Math.Vector3Proto=function(){var a=B.Math,b=a.Type,c=a.EPSILON,d=a.equal,e=Math.abs,f=Math.sqrt,g=Math.min,h=Math.max;this._type=function(){return b.POINT},this.clone=function(){return a.makeVector3(this.x,this.y,this.z)},this.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},this.set=function(a,b,c){return this.x=a,this.y=b,this.z=c,this},this.get=function(a){switch(a){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("Vector3 index is out of range")}},this.fromArray=function(a,b){return b=b||0,this.x=a[b],this.y=a[b+1],this.z=a[b+2],b+3},this.toArray=function(a,b){return b=b||0,a[b]=this.x,a[b+1]=this.y,a[b+2]=this.z,b+3},this.length=function(){var a=this.x,b=this.y,c=this.z;return Math.sqrt(a*a+b*b+c*c)},this.lengthSq=function(){var a=this.x,b=this.y,c=this.z;return a*a+b*b+c*c},this.normalize=function(){var a=this.lengthSq();return a>0&&e(1-a)>c&&this.mul(1/f(a)),this},this.negate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},this.clamp=function(a,b){return a=a||0,b=b||1,this.x=h(g(this.x,b),a),this.y=h(g(this.y,b),a),this.z=h(g(this.z,b),a),this},this.add=function(a){return"number"==typeof a?(this.x+=a,this.y+=a,this.z+=a):(this.x+=a.x,this.y+=a.y,this.z+=a.z),this},this.addVectors=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},this.sub=function(a){return"number"==typeof a?(this.x-=a,this.y-=a,this.z-=a):(this.x-=a.x,this.y-=a.y,this.z-=a.z),this},this.subVectors=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},this.mul=function(a){return"number"==typeof a?(this.x*=a,this.y*=a,this.z*=a):(this.x*=a.x,this.y*=a.y,this.z*=a.z),this},this.mulVectors=function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this},this.div=function(a){return"number"==typeof a?(this.x/=a,this.y/=a,this.z/=a):(this.x/=a.x,this.y/=a.y,this.z/=a.z),this},this.divVectors=function(a,b){return this.x=a.x/b.x,this.y=a.y/b.y,this.z=a.z/b.z,this},this.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},this.cross=function(a){var b=this.x,c=a.x,d=this.y,e=a.y,f=this.z,g=a.z;return this.x=d*g-f*e,this.y=f*c-b*g,this.z=b*e-d*c,this},this.crossVectors=function(a,b){var c=a.x,d=b.x,e=a.y,f=b.y,g=a.z,h=b.z;return this.x=e*h-g*f,this.y=g*d-c*h,this.z=c*f-e*d,this},this.reflect=function(){var b=null;return function(c){var d,e=this.x,f=this.y,g=this.z;return b=(b||a.makeVector3()).copy(c).normalize(),d=e*b.x+f*b.y+g*b.z,this.x=e-2*b.x*d,this.y=f-2*b.y*d,this.z=g-2*b.z*d,this}}(),this.transform3=function(a){var b=a.m,c=this.x,d=this.y,e=this.z;return this.x=b[0]*c+b[3]*d+b[6]*e,this.y=b[1]*c+b[4]*d+b[7]*e,this.z=b[2]*c+b[5]*d+b[8]*e,this},this.transform4=function(a,b){var c=a.m,d=this.x,e=this.y,f=this.z,g=c[12],h=c[13],i=c[14];return 1!==b&&void 0!==b&&(g*=b,h*=b,i*=b),this.x=c[0]*d+c[4]*e+c[8]*f+g,this.y=c[1]*d+c[5]*e+c[9]*f+h,this.z=c[2]*d+c[6]*e+c[10]*f+i,this},this.transform=function(a,b){return a instanceof B.Math.Matrix3?this.transform3(a):this.transform4(a,b)},this.rotate=function(){var b=function(a,b){var c=a.x,d=a.y,e=a.z,f=b._w,g=b._x,h=b._y,i=b._z,j=-g*c-h*d-i*e,k=f*c+h*e-i*d,l=f*d+i*c-g*e,m=f*e+g*d-h*c;a.x=k*f-j*g-l*i+m*h,a.y=l*f-j*h-m*g+k*i,a.z=m*f-j*i-k*h+l*g},c=function(){var c=null;return function(d,e){c=c||a.makeQuaternion(),b(d,c.fromAngles(e))}}();return function(a){return a instanceof B.Math.Quaternion?b(this,a):c(this,a),this}}(),this.angleTo=function(a){var b=this.dot(a)/(this.length()*a.length());return Math.acos(g(h(b,-1),1))},this.distanceTo=function(a){return Math.sqrt(this.distanceToSq(a))},this.distanceToSq=function(a){var b=this.x-a.x,c=this.y-a.y,d=this.z-a.z;return b*b+c*c+d*d},this.equal=function(a){return d(a.x,this.x)&&d(a.y,this.y)&&d(a.z,this.z)}},B.Math.Vector3=function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0},B.Math.Vector3.prototype=new B.Math.Vector3Proto,B.Math.Vector3.ZERO=B.Math.makeVector3(0,0,0),B.Math.Vector3.INF=B.Math.makeVector3(1/0,1/0,1/0),B.Math.Vector3.N_INF=B.Math.makeVector3(-1/0,-1/0,-1/0),B.Math.Vector3.X=B.Math.makeVector3(1,0,0),B.Math.Vector3.Y=B.Math.makeVector3(0,1,0),B.Math.Vector3.Z=B.Math.makeVector3(0,0,1),B.Math.Vector3.N_X=B.Math.makeVector3(-1,0,0),B.Math.Vector3.N_Y=B.Math.makeVector3(0,-1,0),B.Math.Vector3.N_Z=B.Math.makeVector3(0,0,-1),B.Math.Vector4Proto=function(){var a=B.Math,b=a.EPSILON,c=a.equal,d=Math.abs,e=Math.sqrt,f=Math.min,g=Math.max;this.clone=function(){return a.makeVector4(this.x,this.y,this.z,this.w)},this.copy=function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this.w=a.w,this},this.set=function(a,b,c,d){return this.x=a,this.y=b,this.z=c,this.w=d,this},this.get=function(a){switch(a){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("Vector4 index is out of range")}},this.fromArray=function(a,b){return b=b||0,this.x=a[b],this.y=a[b+1],this.z=a[b+2],this.w=a[b+3],b+4},this.toArray=function(a,b){return b=b||0,a[b]=this.x,a[b+1]=this.y,a[b+2]=this.z,a[b+3]=this.w,b+4},this.length=function(){var a=this.x,b=this.y,c=this.z,d=this.w;return Math.sqrt(a*a+b*b+c*c+d*d)},this.lengthSq=function(){var a=this.x,b=this.y,c=this.z,d=this.w;return a*a+b*b+c*c+d*d},this.normalize=function(){var a=this.lengthSq();return a>0&&d(1-a)>b&&this.mul(1/e(a)),this},this.negate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this},this.clamp=function(a,b){return a=a||0,b=b||1,this.x=g(f(this.x,b),a),this.y=g(f(this.y,b),a),this.z=g(f(this.z,b),a),this.w=g(f(this.w,b),a),this},this.add=function(a){return"number"==typeof a?(this.x+=a,this.y+=a,this.z+=a,this.w+=a):(this.x+=a.x,this.y+=a.y,this.z+=a.z,this.w+=a.w),this},this.addVectors=function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w,this},this.sub=function(a){return"number"==typeof a?(this.x-=a,this.y-=a,this.z-=a,this.w-=a):(this.x-=a.x,this.y-=a.y,this.z-=a.z,this.w-=a.w),this},this.subVectors=function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w,this},this.mul=function(a){return"number"==typeof a?(this.x*=a,this.y*=a,this.z*=a,this.w*=a):(this.x*=a.x,this.y*=a.y,this.z*=a.z,this.w*=a.w),this},this.mulVectors=function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this.w=a.w*b.w,this},this.div=function(a){return"number"==typeof a?(this.x/=a,this.y/=a,this.z/=a,this.w/=a):(this.x/=a.x,this.y/=a.y,this.z/=a.z,this.w/=a.w),this},this.divVectors=function(a,b){return this.x=a.x/b.x,this.y=a.y/b.y,this.z=a.z/b.z,this.w=a.w/b.w,this},this.transform=function(a){var b=a.m,c=this.x,d=this.y,e=this.z,f=this.w;return this.x=b[0]*c+b[4]*d+b[8]*e+b[12]*f,this.y=b[1]*c+b[5]*d+b[9]*e+b[13]*f,this.z=b[2]*c+b[6]*d+b[10]*e+b[14]*f,this.w=b[3]*c+b[7]*d+b[11]*e+b[15]*f,this},this.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w},this.equal=function(a){return c(a.x,this.x)&&c(a.y,this.y)&&c(a.z,this.z)&&c(a.w,this.w)}},B.Math.Vector4=function(a,b,c,d){this.x=a||0,this.y=b||0,this.z=c||0,this.w=d||0},B.Math.Vector4.prototype=new B.Math.Vector4Proto,B.Math.Vector4.ZERO=B.Math.makeVector4(0,0,0,0),B.Math.Matrix3Proto=function(){var a=B.Math,b=a.EPSILON,c=3,d=3,e=c*d,f=a.equal,g=Math.abs,h=Math.sin,i=Math.cos;this.clone=function(){var b=a.makeMatrix3();return b.fromArray(this.m),b},this.copy=function(a){return this.fromArray(a.m),this},this.set=function(a,b,c,d,e,f,g,h,i){var j=this.m;return j[0]=a,j[1]=d,j[2]=g,j[3]=b,j[4]=e,j[5]=h,j[6]=c,j[7]=f,j[8]=i,this},this.get=function(a,b){if(0>b||b>=d)throw new Error("Matrix3 column index is out of range");if(0>a||a>=c)throw new Error("Matrix3 row index is out of range");return this.m[b*c+a]},this.setAxisX=function(a){var b=this.m;return b[0]=a.x,b[1]=a.y,b[2]=a.z,this},this.getAxisX=function(b){var c=this.m,d=b||a.makeVector3();return d.set(c[0],c[1],c[2])},this.setAxisY=function(a){var b=this.m;return b[3]=a.x,b[4]=a.y,b[5]=a.z,this},this.getAxisY=function(b){var c=this.m,d=b||a.makeVector3();return d.set(c[3],c[4],c[5])},this.setAxisZ=function(a){var b=this.m;return b[6]=a.x,b[7]=a.y,b[8]=a.z,this},this.getAxisZ=function(b){var c=this.m,d=b||a.makeVector3();return d.set(c[6],c[7],c[8])},this.extractScale=function(){var b=a.makeVector3();return function(c){return c=c||a.makeVector3(),c.set(this.getAxisX(b).length(),this.getAxisY(b).length(),this.getAxisZ(b).length())}}(),this.fromArray=function(a,b){var c,d=this.m;for(b=b||0,c=0;e>c;c+=1)d[c]=a[c+b];return b+e},this.toArray=function(a,b){var c,d=this.m;for(b=b||0,c=0;e>c;c+=1)a[c+b]=d[c];return b+e},this.fromAngles=function(a){var b=a.pitch(),c=a.yaw(),d=a.roll(),e=i(b),f=i(c),g=i(d),j=h(b),k=h(c),l=h(d),m=f*g,n=f*l,o=k*g,p=k*l;return this.set(m+p*j,o*j-n,e*k,e*l,e*g,-j,n*j-o,p+m*j,e*f)},this.fromQuaternion=function(a){var b=a._x,c=a._y,d=a._z,e=a._w,f=2*b,g=2*c,h=2*d,i=b*f,j=b*g,k=b*h,l=c*g,m=c*h,n=d*h,o=e*f,p=e*g,q=e*h;return this.set(1-l-n,j-q,k+p,j+q,1-i-n,m-o,k-p,m+o,1-i-l)},this.identity=function(){return this.set(1,0,0,0,1,0,0,0,1)},this.rotationX=function(a){var b=i(a),c=h(a);return this.set(1,0,0,0,b,-c,0,c,b)},this.rotationY=function(a){var b=i(a),c=h(a);return this.set(b,0,c,0,1,0,-c,0,b)},this.rotationZ=function(a){var b=i(a),c=h(a);return this.set(b,-c,0,c,b,0,0,0,1)},this.rotationAxis=function(){var b=a.makeVector3();return function(a,c){var d=b.copy(a).normalize().x,e=b.y,f=b.z,g=i(c),j=h(c),k=1-g,l=k*d,m=k*e;return this.set(l*d+g,l*e-j*f,l*f+j*e,l*e+j*f,m*e+g,m*f-j*d,l*f-j*e,m*f+j*d,k*f*f+g)}}(),this.scale=function(a,b,c){return this.set(a,0,0,0,b,0,0,0,c)},this.add=function(a){var b=this.m,c=a.m;return b[0]+=c[0],b[1]+=c[1],b[2]+=c[2],b[3]+=c[3],b[4]+=c[4],b[5]+=c[5],b[6]+=c[6],b[7]+=c[7],b[8]+=c[8],this},this.mulScalar=function(a){var b,c=this.m;for(b=0;e>b;b+=1)c[b]*=a;return this},this.mulMatrices=function(a,b){var c=this.m,d=a.m,e=b.m,f=d[0],g=d[3],h=d[6],i=d[1],j=d[4],k=d[7],l=d[2],m=d[5],n=d[8],o=e[0],p=e[3],q=e[6],r=e[1],s=e[4],t=e[7],u=e[2],v=e[5],w=e[8];return c[0]=f*o+i*p+l*q,c[3]=g*o+j*p+m*q,c[6]=h*o+k*p+n*q,c[1]=f*r+i*s+l*t,c[4]=g*r+j*s+m*t,c[7]=h*r+k*s+n*t,c[2]=f*u+i*v+l*w,c[5]=g*u+j*v+m*w,c[8]=h*u+k*v+n*w,this},this.mul=function(a){return"number"==typeof a?this.mulScalar(a):this.mulMatrices(this,a)},this.determinant=function(){var a=this.m,b=a[0],c=a[3],d=a[6],e=a[1],f=a[4],g=a[7],h=a[2],i=a[5],j=a[8];return(f*j-g*i)*b+(d*i-c*j)*e+(c*g-d*f)*h},this.transpose=function(){var a=this.m;return this.set(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},this.invert=function(){var a,c=this.m,d=c[0],e=c[3],f=c[6],h=c[1],i=c[4],j=c[7],k=c[2],l=c[5],m=c[8];if(c[0]=i*m-j*l,c[3]=f*l-e*m,c[6]=e*j-f*i,c[1]=j*k-h*m,c[4]=d*m-f*k,c[7]=f*h-d*j,c[2]=h*l-i*k,c[5]=e*k-d*l,c[8]=d*i-e*h,a=d*c[0]+h*c[3]+k*c[6],g(a)<b)throw new Error("can't invert Matrix3 - determinant is zero");return this.mulScalar(1/a)},this.equal=function(a){var b,c=this.m,d=a.m;for(b=0;e>b;b+=1)if(!f(c[b],d[b]))return!1;return!0}},B.Math.Matrix3=function(a,b,c,d,e,f,g,h,i){this.m=0!==arguments.length?[a,d,g,b,e,h,c,f,i]:[1,0,0,0,1,0,0,0,1]},B.Math.Matrix3.prototype=new B.Math.Matrix3Proto,B.Math.Matrix3.ZERO=B.Math.makeMatrix3(0,0,0,0,0,0,0,0,0),B.Math.Matrix3.IDENTITY=B.Math.makeMatrix3(),B.Math.Matrix4Proto=function(){var a=B.Math,b=a.EPSILON,c=4,d=4,e=c*d,f=a.equal,g=Math.abs,h=Math.sin,i=Math.cos;this.clone=function(){var b=a.makeMatrix4();return b.fromArray(this.m),b},this.copy=function(a){return this.fromArray(a.m),this},this.set=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=this.m;return q[0]=a,q[1]=e,q[2]=i,q[3]=m,q[4]=b,q[5]=f,q[6]=j,q[7]=n,q[8]=c,q[9]=g,q[10]=k,q[11]=o,q[12]=d,q[13]=h,q[14]=l,q[15]=p,this},this.get=function(a,b){if(0>b||b>=d)throw new Error("Matrix4 column index is out of range");if(0>a||a>=c)throw new Error("Matrix4 row index is out of range");return this.m[b*c+a]},this.setMatrix3=function(a){var b=this.m,c=a.m;return b[0]=c[0],b[1]=c[1],b[2]=c[2],b[4]=c[3],b[5]=c[4],b[6]=c[5],b[8]=c[6],b[9]=c[7],b[10]=c[8],this},this.getMatrix3=function(b){var c=this.m;return b=b||a.makeMatrix3(),b.set(c[0],c[4],c[8],c[1],c[5],c[9],c[2],c[6],c[10])},this.setAxisX=function(a){var b=this.m;return b[0]=a.x,b[1]=a.y,b[2]=a.z,this},this.getAxisX=function(b){var c=this.m,d=b||a.makeVector3();return d.set(c[0],c[1],c[2])},this.setAxisY=function(a){var b=this.m;return b[4]=a.x,b[5]=a.y,b[6]=a.z,this},this.getAxisY=function(b){var c=this.m,d=b||a.makeVector3();return d.set(c[4],c[5],c[6])},this.setAxisZ=function(a){var b=this.m;return b[8]=a.x,b[9]=a.y,b[10]=a.z,this},this.getAxisZ=function(b){var c=this.m,d=b||a.makeVector3();return d.set(c[8],c[9],c[10])},this.setPosition=function(a){var b=this.m;return b[12]=a.x,b[13]=a.y,b[14]=a.z,this},this.getPosition=function(b){var c=this.m,d=b||a.makeVector3();return d.set(c[12],c[13],c[14])},this.extractScale=function(){var b=a.makeVector3();return function(c){return c=c||a.makeVector3(),c.set(this.getAxisX(b).length(),this.getAxisY(b).length(),this.getAxisZ(b).length())}}(),this.fromArray=function(a,b){var c,d=this.m;for(b=b||0,c=0;e>c;c+=1)d[c]=a[c+b];return b+e},this.toArray=function(a,b){var c,d=this.m;for(b=b||0,c=0;e>c;c+=1)a[c+b]=d[c];return b+e},this.fromAngles=function(){var b=a.makeMatrix3();return function(a){return this.identity().setMatrix3(b.fromAngles(a))}}(),this.fromQuaternion=function(){var b=a.makeMatrix3();return function(a){return this.identity().setMatrix3(b.fromQuaternion(a))}}(),this.identity=function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},this.translation=function(a,b,c){return this.set(1,0,0,a,0,1,0,b,0,0,1,c,0,0,0,1)},this.rotationX=function(a){var b=i(a),c=h(a);return this.set(1,0,0,0,0,b,-c,0,0,c,b,0,0,0,0,1)},this.rotationY=function(a){var b=i(a),c=h(a);return this.set(b,0,c,0,0,1,0,0,-c,0,b,0,0,0,0,1)},this.rotationZ=function(a){var b=i(a),c=h(a);return this.set(b,-c,0,0,c,b,0,0,0,0,1,0,0,0,0,1)},this.rotationAxis=function(){var b=a.makeMatrix3();return function(a,c){return this.identity().setMatrix3(b.rotationAxis(a,c))}}(),this.scale=function(a,b,c){return this.set(a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1)},this.lookAt=function(){var b=a.makeVector3(),c=a.makeVector3(),d=a.makeVector3();return function(e,f,g){return d.subVectors(e,f).normalize(),b.crossVectors(g,d).normalize(),b.length()<a.EPSILON&&(d.x+=a.EPSILON,b.crossVectors(g,d).normalize()),c.crossVectors(d,b),this.set(b.x,b.y,b.z,-b.dot(e),c.x,c.y,c.z,-c.dot(e),d.x,d.y,d.z,-d.dot(e),0,0,0,1)}}(),this.orthographic=function(a,b,c,d){var e=2/a,f=2/b,g=-1/(d-c),h=2*g,i=(d+c)*g;return this.set(e,0,0,0,0,f,0,0,0,0,h,i,0,0,0,1)},this.perspective=function(a,b,c,d){var e=Math.tan(.5*a),f=1/(b*e),g=1/e,h=-1/(d-c),i=(d+c)*h,j=2*d*c*h;return this.set(f,0,0,0,0,g,0,0,0,0,i,j,0,0,-1,0)},this.add=function(a){var b=this.m,c=a.m;return b[0]+=c[0],b[1]+=c[1],b[2]+=c[2],b[3]+=c[3],b[4]+=c[4],b[5]+=c[5],b[6]+=c[6],b[7]+=c[7],b[8]+=c[8],b[9]+=c[9],b[10]+=c[10],b[11]+=c[11],b[12]+=c[12],b[13]+=c[13],b[14]+=c[14],b[15]+=c[15],this},this.mulScalar=function(a){var b,c=this.m;for(b=0;e>b;b+=1)c[b]*=a;return this},this.mulMatrices=function(a,b){var c=this.m,d=a.m,e=b.m,f=d[0],g=d[4],h=d[8],i=d[12],j=d[1],k=d[5],l=d[9],m=d[13],n=d[2],o=d[6],p=d[10],q=d[14],r=d[3],s=d[7],t=d[11],u=d[15],v=e[0],w=e[4],x=e[8],y=e[12],z=e[1],A=e[5],B=e[9],C=e[13],D=e[2],E=e[6],F=e[10],G=e[14],H=e[3],I=e[7],J=e[11],K=e[15];return c[0]=f*v+j*w+n*x+r*y,c[4]=g*v+k*w+o*x+s*y,c[8]=h*v+l*w+p*x+t*y,c[12]=i*v+m*w+q*x+u*y,c[1]=f*z+j*A+n*B+r*C,c[5]=g*z+k*A+o*B+s*C,c[9]=h*z+l*A+p*B+t*C,c[13]=i*z+m*A+q*B+u*C,c[2]=f*D+j*E+n*F+r*G,c[6]=g*D+k*E+o*F+s*G,c[10]=h*D+l*E+p*F+t*G,c[14]=i*D+m*E+q*F+u*G,c[3]=f*H+j*I+n*J+r*K,c[7]=g*H+k*I+o*J+s*K,c[11]=h*H+l*I+p*J+t*K,c[15]=i*H+m*I+q*J+u*K,this},this.mul=function(a){return"number"==typeof a?this.mulScalar(a):this.mulMatrices(this,a)},this.determinant=function(){var a=this.m,b=a[0],c=a[4],d=a[8],e=a[12],f=a[1],g=a[5],h=a[9],i=a[13],j=a[2],k=a[6],l=a[10],m=a[14],n=a[3],o=a[7],p=a[11],q=a[15],r=e*f,s=e*g,t=e*h,u=d*f,v=d*g,w=d*i,x=c*f,y=c*h,z=c*i,A=b*g,B=b*h,C=b*i;return(t*k-w*k-s*l+z*l+v*m-y*m)*n+(w*j-t*j+r*l-C*l-u*m+B*m)*o+(s*j-z*j-r*k+x*m-A*m-C*k)*p+(v*j+y*j+u*k-B*k-x*l+A*l)*q},this.transpose=function(){var a=this.m;return this.set(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15])},this.invert=function(){var a,c=this.m,d=c[0],e=c[4],f=c[8],h=c[12],i=c[1],j=c[5],k=c[9],l=c[13],m=c[2],n=c[6],o=c[10],p=c[14],q=c[3],r=c[7],s=c[11],t=c[15];if(c[0]=k*p*r-l*o*r+l*n*s-j*p*s-k*n*t+j*o*t,c[4]=h*o*r-f*p*r-h*n*s+e*p*s+f*n*t-e*o*t,c[8]=f*l*r-h*k*r+h*j*s-e*l*s-f*j*t+e*k*t,c[12]=h*k*n-f*l*n-h*j*o+e*l*o+f*j*p-e*k*p,c[1]=l*o*q-k*p*q-l*m*s+i*p*s+k*m*t-i*o*t,c[5]=f*p*q-h*o*q+h*m*s-d*p*s-f*m*t+d*o*t,c[9]=h*k*q-f*l*q-h*i*s+d*l*s+f*i*t-d*k*t,c[13]=f*l*m-h*k*m+h*i*o-d*l*o-f*i*p+d*k*p,c[2]=j*p*q-l*n*q+l*m*r-i*p*r-j*m*t+i*n*t,c[6]=h*n*q-e*p*q-h*m*r+d*p*r+e*m*t-d*n*t,c[10]=e*l*q-h*j*q+h*i*r-d*l*r-e*i*t+d*j*t,c[14]=h*j*m-e*l*m-h*i*n+d*l*n+e*i*p-d*j*p,c[3]=k*n*q-j*o*q-k*m*r+i*o*r+j*m*s-i*n*s,c[7]=e*o*q-f*n*q+f*m*r-d*o*r-e*m*s+d*n*s,c[11]=f*j*q-e*k*q-f*i*r+d*k*r+e*i*s-d*j*s,c[15]=e*k*m-f*j*m+f*i*n-d*k*n-e*i*o+d*j*o,a=d*c[0]+i*c[4]+m*c[8]+q*c[12],g(a)<b)throw new Error("can't invert Matrix4 - determinant is zero");return this.mulScalar(1/a)},this.equal=function(a){var b,c=this.m,d=a.m;for(b=0;e>b;b+=1)if(!f(c[b],d[b]))return!1;return!0}},B.Math.Matrix4=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){this.m=0!==arguments.length?[a,e,i,m,b,f,j,n,c,g,k,o,d,h,l,p]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},B.Math.Matrix4.prototype=new B.Math.Matrix4Proto,B.Math.Matrix4.ZERO=B.Math.makeMatrix4(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),B.Math.Matrix4.IDENTITY=B.Math.makeMatrix4(),B.Math.QuaternionProto=function(){var a=B.Math,b=a.EPSILON,c=a.equal,d=Math.cos,e=Math.sin,f=Math.atan2,g=Math.sqrt,h=Math.abs;this.clone=function(){return a.makeQuaternion(this._w,this._x,this._y,this._z)},this.copy=function(a){return this._w=a._w,this._x=a._x,this._y=a._y,this._z=a._z,this},this.set=function(a,b,c,d){return this._w=a,this._x=b,this._y=c,this._z=d,this._normalize()},this.get=function(a){switch(a){case 0:return this._w;case 1:return this._x;case 2:return this._y;case 3:return this._z;default:throw new Error("Quaternion index is out of range")}},this.fromArray=function(a,b){return b=b||0,this._w=a[b],this._x=a[b+1],this._y=a[b+2],this._z=a[b+3],this._normalize(),b+4},this.toArray=function(a,b){return b=b||0,a[b]=this._w,a[b+1]=this._x,a[b+2]=this._y,a[b+3]=this._z,b+4},this.fromAxisAngle=function(){var b=a.makeVector3();return function(a,c){var f=.5*c,g=e(f);return b.copy(a).normalize(),this.set(d(f),b.x*g,b.y*g,b.z*g)}}(),this.fromRotationMatrix=function(){var b=a.makeMatrix3();return function(c){var d,e=c instanceof a.Matrix4?c.getMatrix3(b).m:c.m,f=e[0],h=e[3],i=e[6],j=e[1],k=e[4],l=e[7],m=e[2],n=e[5],o=e[8],p=f+k+o,q=f-k-o,r=k-f-o,s=o-f-k,t=p,u=0;switch(q>t?(t=q,u=1):r>t?(t=r,u=2):s>t&&(t=s,u=3),t=.5*g(1+t),d=.25/t,u){case 0:return this.set(t,(n-l)*d,(i-m)*d,(j-h)*d);case 1:return this.set((n-l)*d,t,(h+j)*d,(i+m)*d);case 2:return this.set((i-m)*d,(h+j)*d,t,(l+n)*d);case 3:return this.set((j-h)*d,(i+m)*d,(l+n)*d,t)}}}(),this.fromAngles=function(a){var b=.5*a.pitch(),c=.5*a.yaw(),f=.5*a.roll(),g=d(b),h=d(c),i=d(f),j=e(b),k=e(c),l=e(f);return this.set(h*g*i-k*j*l,h*j*i+k*g*l,k*g*i-h*j*l,h*g*l-k*j*i)},this.axis=function(c){var d=this._w,e=g(1-d*d),f=c||a.makeVector3();return b>e?f.set(0,0,0):f.set(this._x,this._y,this._z).mul(1/e).normalize()},this.angle=function(){var a=this._w,b=this._x,c=this._y,d=this._z;return 2*f(g(b*b+c*c+d*d),h(a))},this.mulQuaternions=function(a,b){var c=a._w,d=a._x,e=a._y,f=a._z,g=b._w,h=b._x,i=b._y,j=b._z;return this._w=g*c-h*d-i*e-j*f,this._x=h*c+g*d+i*f-j*e,this._y=i*c+g*e+j*d-h*f,this._z=j*c+g*f+h*e-i*d,this},this.mul=function(a){return this.mulQuaternions(this,a)},this.dot=function(a){var b=this._w,c=this._x,d=this._y,e=this._z,f=a._w,g=a._x,h=a._y,i=a._z;return b*f+c*g+d*h+e*i},this.invert=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this},this.slerp=function(c,d,h){var i,j,k,l,m=this._w,n=this._x,o=this._y,p=this._z,q=c._w,r=c._x,s=c._y,t=c._z,u=m*q+n*r+o*s+p*t;return h=h||a.makeQuaternion(),b>u&&(q=-q,r=-r,s=-s,t=-t,u=-u),u>1-b?h.set(m,n,o,p):(l=g(1-u*u),k=f(l,u),i=e((1-d)*k)/l,j=e(d*k)/l,h.set(m*i+q*j,n*i+r*j,o*i+s*j,p*i+t*j))},this.equal=function(a){return c(a._w,this._w)&&c(a._x,this._x)&&c(a._y,this._y)&&c(a._z,this._z)},this._normalize=function(){var a=this._w,c=this._x,d=this._y,e=this._z,f=a*a+c*c+d*d+e*e;return b>f?(this._w=1,this._x=0,this._y=0,this._z=0):(f=1/g(f),this._w*=f,this._x*=f,this._y*=f,this._z*=f),this}},B.Math.Quaternion=function(a,b,c,d){this._w=void 0!==a?a:1,this._x=b||0,this._y=c||0,this._z=d||0,this._normalize()},B.Math.Quaternion.prototype=new B.Math.QuaternionProto,B.Math.Quaternion.IDENTITY=B.Math.makeQuaternion(),B.Math.AnglesProto=function(){var a=B.Math,b=a.EPSILON,c=1-b,d=a.equal,e=Math.min,f=Math.max,g=Math.abs,h=Math.asin,i=Math.atan2,j=function(a){return e(f(a,-1),1)};this.clone=function(){return a.makeAngles(this._yaw,this._pitch,this._roll)},this.copy=function(a){return this._yaw=a._yaw,this._pitch=a._pitch,this._roll=a._roll,this},this.set=function(a,b,c){return this._yaw=a,this._pitch=b,this._roll=c,this._canonize()},this.get=function(a){switch(a){case 0:return this._yaw;case 1:return this._pitch;case 2:return this._roll;default:throw new Error("Angles the index is out of range")}},this.yaw=function(a){return 0===arguments.length?this._yaw:(this._yaw=a,this._canonize())},this.pitch=function(a){return 0===arguments.length?this._pitch:(this._pitch=a,this._canonize())},this.roll=function(a){return 0===arguments.length?this._roll:(this._roll=a,this._canonize())},this.fromArray=function(a,b){return b=b||0,this._yaw=a[b],this._pitch=a[b+1],this._roll=a[b+2],this._canonize(),b+3},this.toArray=function(a,b){return b=b||0,a[b]=this._yaw,a[b+1]=this._pitch,a[b+2]=this._roll,b+3},this.fromRotationMatrix=function(){var b=a.makeMatrix3();return function(d){var e=d instanceof a.Matrix4?d.getMatrix3(b).m:d.m,f=j(e[7]);return this._pitch=h(-f),g(f)<c?(this._yaw=i(e[6],e[8]),this._roll=i(e[1],e[4])):(this._yaw=i(0>f?e[3]:-e[3],e[0]),this._roll=0),this}}(),this.fromQuaternion=function(a){var b=a._x,d=a._y,e=a._z,f=a._w,k=2*b,l=2*d,m=2*e,n=j(d*m-f*k);return this._pitch=h(-n),g(n)<c?(this._yaw=i(b*m+f*l,1-b*k-d*l),this._roll=i(b*l+f*m,1-b*k-e*m)):(this._yaw=i(0>n?b*l-f*m:f*m-b*l,1-d*l-e*m),this._roll=0),this},this.equal=function(a){return d(a._yaw,this._yaw)&&d(a._pitch,this._pitch)&&d(a._roll,this._roll)},this._canonize=function(){var a=Math.PI,c=.5*a,d=2*a,e=1/d,f=Math.floor,h=function(b){return(-a>b||b>a)&&(b+=a,b-=f(b*e)*d,b-=a),b};return function(){var d=this._yaw,e=this._pitch,f=this._roll;return e=h(e),-c>e?(e=-a-e,d+=a,f+=a):e>c&&(e=a-e,d+=a,f+=a),g(c-g(e))<b?(d=0>e?d+f:d-f,f=0):f=h(f),d=h(d),this._yaw=d,this._pitch=e,this._roll=f,this}}()},B.Math.Angles=function(a,b,c){this._yaw=a||0,this._pitch=b||0,this._roll=c||0,this._canonize()},B.Math.Angles.prototype=new B.Math.AnglesProto,B.Math.PlaneProto=function(){var a=B.Math,b=a.Type,c=a.EPSILON,d=a.equal,e=Math.abs,f=Math.sqrt,g=Math.min,h=Math.max;this._type=function(){return b.PLANE},this.clone=function(){return a.makePlane(this.normal.clone(),this.distance)},this.copy=function(a){return this.normal.copy(a.normal),this.distance=a.distance,this},this.set=function(a,b){return this.normal.copy(a),this.distance=b,this},this.fromArray=function(a,b){return b=b||0,b=this.normal.fromArray(a,b),this.distance=a[b],b+1},this.toArray=function(a,b){return b=b||0,b=this.normal.toArray(a,b),a[b]=this.distance,b+1},this.fromNormalPoint=function(a,b){return this.normal.copy(a).normalize(),this.distance=b.dot(this.normal),this},this.fromCoplanarPoints=function(){var b=a.makeVector3();return function(a,c,d){return this.normal.subVectors(d,c).cross(b.subVectors(a,c)).normalize(),this.distance=a.dot(this.normal),this}}(),this.translate=function(a){return this.distance+=a.dot(this.normal),this},this.transform=function(){var b=a.makeVector4(),c=a.makeMatrix4();return function(a){var d=this.normal;return b.set(d.x,d.y,d.z,-this.distance),b.transform(c.copy(a).invert().transpose()),this.normal.set(b.x,b.y,b.z),this.distance=-b.w,this}}(),this.normalize=function(){var a=this.normal.lengthSq();return e(1-a)>c&&(a=1/f(a),this.normal.mul(a),this.distance*=a),this
},this.negate=function(){return this.normal.negate(),this.distance*=-1,this},this.projectPoint=function(b,c){var d=c||a.makeVector3();return d.copy(this.normal).mul(this.normal.dot(b)-this.distance),d.sub(b).negate()},this.distanceTo=function(){var d=function(a,b){return a.normal.dot(b)-a.distance},f=[];return f[b.POINT]=d,f[b.PLANE]=function(a,b){var d=a.distance,f=b.distance,g=a.normal.dot(b.normal);return e(1-e(g))>c?0:g>0?f-d:-(f+d)},f[b.RAY]=function(a,b){var c,e=d(a,b.origin);return 0!==e&&(c=a.normal.dot(b.direction),0>e*c)?0:e},f[b.SEGMENT]=function(a,b){var c=d(a,b.start),e=d(a,b.end);return 0>=c*e?0:c>0?g(c,e):h(c,e)},f[b.TRIANGLE]=function(a,b){var c=a.distanceTo(b.a),d=a.distanceTo(b.b),e=a.distanceTo(b.c);return 0>=c*d||0>=c*e?0:c>0?g(g(c,d),e):h(h(c,d),e)},f[b.AABOX]=function(){var b=a.makeVector3(),c=a.makeVector3();return function(a,e){var f,i,j=a.normal,k=e.min,l=e.max;return b.x=j.x>0?k.x:l.x,c.x=j.x>0?l.x:k.x,b.y=j.y>0?k.y:l.y,c.y=j.y>0?l.y:k.y,b.z=j.z>0?k.z:l.z,c.z=j.z>0?l.z:k.z,f=d(a,b),i=d(a,c),0>=f*i?0:f>0?g(f,i):h(f,i)}}(),f[b.SPHERE]=function(a,b){var c=d(a,b.center),f=b.radius;return e(c)<=f?0:c>0?c-f:c+f},function(a){var b=a&&a._type,c=b&&f[b()];if(!c)throw new Error("unsupported object type");return c(this,a)}}(),this.test=function(b,c){return a.testRelationByDistance(this.distanceTo(b),c)},this.equal=function(a){return a.normal.equal(this.normal)&&d(a.distance,this.distance)}},B.Math.Plane=function(a,b){this.normal=a||B.Math.Vector3.Y.clone(),this.distance=b||0},B.Math.Plane.prototype=new B.Math.PlaneProto,B.Math.Plane.X=B.Math.makePlane(B.Math.Vector3.X),B.Math.Plane.Y=B.Math.makePlane(B.Math.Vector3.Y),B.Math.Plane.Z=B.Math.makePlane(B.Math.Vector3.Z),B.Math.Plane.N_X=B.Math.makePlane(B.Math.Vector3.N_X),B.Math.Plane.N_Y=B.Math.makePlane(B.Math.Vector3.N_Y),B.Math.Plane.N_Z=B.Math.makePlane(B.Math.Vector3.N_Z),B.Math.RayProto=function(){var a=B.Math,b=a.Type;this._type=function(){return b.RAY},this.clone=function(){return a.makeRay(this.origin,this.direction)},this.copy=function(a){return this.origin.copy(a.origin),this.direction.copy(a.direction),this},this.set=function(a,b){return this.origin.copy(a),this.direction.copy(b),this},this.fromArray=function(a,b){return b=b||0,b=this.origin.fromArray(a,b),b=this.direction.fromArray(a,b)},this.toArray=function(a,b){return b=b||0,b=this.origin.toArray(a,b),b=this.direction.toArray(a,b)},this.fromOriginTarget=function(a,b){return this.origin.copy(a),this.direction.copy(b).sub(a).normalize(),this},this.translate=function(a){return this.origin.add(a),this},this.transform=function(a){return this.direction.add(this.origin).transform(a),this.origin.transform(a),this.direction.sub(this.origin),this},this.at=function(b,c){var d=c||a.makeVector3();return d.copy(this.direction).mul(b).add(this.origin)},this.projectPoint=function(b,c){var d=c||a.makeVector3(),e=this.origin,f=this.direction,g=d.subVectors(b,e).dot(f);return 0>=g?d.copy(e):d.copy(f).mul(g).add(e)},this.trace=function(){var c=a.EPSILON,d=[];return d[b.PLANE]=function(a,b){var d,e=b.normal,f=b.distance,g=a.origin,h=e.dot(a.direction);if(Math.abs(h)<c){if(Math.abs(e.dot(g)-f)<c)return 0}else if(d=(f-e.dot(g))/h,d>=0)return d;return null},d[b.TRIANGLE]=function(){var b=a.makePlane(),c=a.makeVector3(),d=a.makeVector3(),e=a.makeVector3();return function(a,f){var g=f.a,h=f.b,i=f.c,j=f.plane(b).normal,k=a.trace(b);return null===k?null:(a.at(k,c),e.subVectors(h,g).cross(d.subVectors(c,g)),j.dot(e)<0?null:(e.subVectors(i,h).cross(d.subVectors(c,h)),j.dot(e)<0?null:(e.subVectors(g,i).cross(d.subVectors(c,i)),j.dot(e)<0?null:k)))}}(),d[b.AABOX]=function(a,b){var c,d,e,f,g,h,i=b.min,j=b.max,k=a.origin,l=a.direction,m=1/l.x,n=1/l.y,o=1/l.z;return m>=0?(c=(i.x-k.x)*m,d=(j.x-k.x)*m):(c=(j.x-k.x)*m,d=(i.x-k.x)*m),n>=0?(e=(i.y-k.y)*n,f=(j.y-k.y)*n):(e=(j.y-k.y)*n,f=(i.y-k.y)*n),c>f||e>d?null:((e>c||c!==c)&&(c=e),(d>f||d!==d)&&(d=f),o>=0?(g=(i.z-k.z)*o,h=(j.z-k.z)*o):(g=(j.z-k.z)*o,h=(i.z-k.z)*o),c>h||g>d?null:((g>c||c!==c)&&(c=g),(d>h||d!==d)&&(d=h),0>d?null:c>=0?c:d))},d[b.SPHERE]=function(){var a=B.Math.makeVector3();return function(b,c){var d,e,f,g,h,i=c.radius,j=b.direction;return a.subVectors(b.origin,c.center),d=2*a.dot(j),e=a.dot(a)-i*i,f=d*d-4*e,0>f?null:(g=(Math.sqrt(f)-d)/2,h=-(d+Math.sqrt(f))/2,0>g&&0>h?null:0>g*h?Math.max(g,h):Math.min(g,h))}}(),function(a,b){var c,e=a&&a._type,f=e&&d[e()];if(!f)throw new Error("unsupported object type");return c=f(this,a),b&&null!==c&&this.at(c,b),c}}(),this.distanceTo=function(){var a=[];return a[b.POINT]=function(){var a=B.Math.makeVector3();return function(b,c){return b.projectPoint(c,a).distanceTo(c)}}(),a[b.RAY]=function(){var a=B.Math,b=a.EPSILON*a.EPSILON,c=a.makeVector3(),d=a.makeVector3();return function(a,e){var f,g,h=a.origin,i=a.direction,j=e.origin,k=e.direction,l=c.crossVectors(i,k).lengthSq();return b>l?(f=c.subVectors(j,h).dot(i)/i.length(),0>f?(g=c.subVectors(h,j).dot(k)/k.length(),h.distanceTo(0>g?j:c.copy(k).mul(g).add(j))):j.distanceTo(c.copy(i).mul(f).add(h))):(f=d.subVectors(j,h).cross(k).dot(c)/l,g=d.subVectors(j,h).cross(i).dot(c)/l,0>f?h.distanceTo(e.projectPoint(h,c)):0>g?j.distanceTo(a.projectPoint(j,c)):(c.copy(i).mul(f).add(h),d.copy(k).mul(g).add(j),c.distanceTo(d)))}}(),function(b){var c=b&&b._type,d=c&&a[c()];if(!d)throw new Error("unsupported object type");return d(this,b)}}(),this.equal=function(a){return a.origin.equal(this.origin)&&a.direction.equal(this.direction)}},B.Math.Ray=function(a,b){var c=B.Math.Vector3;this.origin=a||c.ZERO.clone(),this.direction=b&&b.normalize()||c.Z.clone()},B.Math.Ray.prototype=new B.Math.RayProto,B.Math.SegmentProto=function(){var a=B.Math,b=a.Type;this._type=function(){return b.SEGMENT},this.clone=function(){return a.makeSegment(this.start,this.end)},this.copy=function(a){return this.start.copy(a.start),this.end.copy(a.end),this},this.set=function(a,b){return this.start.copy(a),this.end.copy(b),this},this.fromArray=function(a,b){return b=b||0,b=this.start.fromArray(a,b),b=this.end.fromArray(a,b)},this.toArray=function(a,b){return b=b||0,b=this.start.toArray(a,b),b=this.end.toArray(a,b)},this.translate=function(a){return this.start.add(a),this.end.add(a),this},this.transform=function(a){return this.start.transform(a),this.end.transform(a),this},this.center=function(b){var c=b||a.makeVector3();return c.addVectors(this.start,this.end).mul(.5)},this.delta=function(b){var c=b||a.makeVector3();return c.subVectors(this.end,this.start)},this.length=function(){return this.start.distanceTo(this.end)},this.at=function(b,c){var d=c||a.makeVector3();return this.delta(d).mul(b).add(this.start)},this.projectPoint=function(){var b=a.makeVector3();return function(c,d){var e=d||a.makeVector3(),f=this.start,g=this.end,h=b.subVectors(g,f).dot(b),i=e.subVectors(c,f).dot(b);return 0>=i?e.copy(f):i>=h?e.copy(g):e.copy(b).mul(i/h).add(f)}}(),this.trace=function(){var b=a.makeRay();return function(a,c){var d=b.fromOriginTarget(this.start,this.end).trace(a);return null!==d&&d<=this.length()?(c&&b.at(d,c),d):null}}(),this.distanceTo=function(){var c=[];return c[b.POINT]=function(){var b=a.makeVector3();return function(a,c){return a.projectPoint(c,b).distanceTo(c)}}(),function(a){var b=a&&a._type,d=b&&c[b()];if(!d)throw new Error("unsupported object type");return d(this,a)}}(),this.equal=function(a){return a.start.equal(this.start)&&a.end.equal(this.end)}},B.Math.Segment=function(a,b){var c=B.Math.Vector3;this.start=a||c.ZERO.clone(),this.end=b||c.ZERO.clone()},B.Math.Segment.prototype=new B.Math.SegmentProto,B.Math.TriangleProto=function(){var a=B.Math,b=a.Type;this._type=function(){return b.TRIANGLE},this.clone=function(){return a.makeTriangle(this.a,this.b,this.c)},this.copy=function(a){return this.a.copy(a.a),this.b.copy(a.b),this.c.copy(a.c),this},this.set=function(a,b,c){return this.a.copy(a),this.b.copy(b),this.c.copy(c),this},this.fromArray=function(a,b){return b=b||0,b=this.a.fromArray(a,b),b=this.b.fromArray(a,b),b=this.c.fromArray(a,b)},this.toArray=function(a,b){return b=b||0,b=this.a.toArray(a,b),b=this.b.toArray(a,b),b=this.c.toArray(a,b)},this.translate=function(a){return this.a.add(a),this.b.add(a),this.c.add(a),this},this.transform=function(a){return this.a.transform(a),this.b.transform(a),this.c.transform(a),this},this.normal=function(){var b=a.makeVector3();return function(c){var d=this.a,e=this.b,f=this.c,g=c||a.makeVector3();return g.subVectors(f,e).cross(b.subVectors(d,e)).normalize()}}(),this.plane=function(b){var c=b||a.makePlane();return c.fromCoplanarPoints(this.a,this.b,this.c)},this.area=function(){var b=a.makeVector3(),c=a.makeVector3();return function(){return b.subVectors(this.c,this.b),c.subVectors(this.a,this.b),.5*b.cross(c).length()}}(),this.perimeter=function(){var a=this.a,b=this.b,c=this.c;return a.distanceTo(b)+b.distanceTo(c)+c.distanceTo(a)},this.centroid=function(b){var c=b||a.makeVector3();return c.addVectors(this.a,this.b).add(this.c).div(3)},this.barycentric=function(){var b=a.makeVector3(),c=a.makeVector3(),d=a.makeVector3();return function(e,f){var g,h,i,j,k,l,m,n,o,p=f||a.makeVector3(),q=this.a,r=this.b,s=this.c;if(b.subVectors(s,q),c.subVectors(r,q),d.subVectors(e,q),g=b.dot(b),h=b.dot(c),i=b.dot(d),j=c.dot(c),k=c.dot(d),l=g*j-h*h,0===l)throw new Error("can't compute barycentric coordinates - triangle is collinear or singular");return m=1/l,n=(j*i-h*k)*m,o=(g*k-h*i)*m,p.set(1-n-o,o,n)}}(),this.equal=function(a){return a.a.equal(this.a)&&a.b.equal(this.b)&&a.c.equal(this.c)}},B.Math.Triangle=function(a,b,c){var d=B.Math.Vector3;this.a=a||d.ZERO.clone(),this.b=b||d.ZERO.clone(),this.c=c||d.ZERO.clone()},B.Math.Triangle.prototype=new B.Math.TriangleProto,B.Math.AABoxProto=function(){var a=B.Math,b=a.Type;this._type=function(){return b.AABOX},this.clone=function(){return a.makeAABox(this.min,this.max)},this.copy=function(a){return this.min.copy(a.min),this.max.copy(a.max),this},this.set=function(a,b){return this.min.copy(a),this.max.copy(b),this},this.fromArray=function(a,b){return b=b||0,b=this.min.fromArray(a,b),b=this.max.fromArray(a,b)},this.toArray=function(a,b){return b=b||0,b=this.min.toArray(a,b),b=this.max.toArray(a,b)},this.fromCenterSize=function(){var b=a.makeVector3();return function(a,c){return b.copy(c).mul(.5),this.min.copy(a).sub(b),this.max.copy(a).add(b),this}}(),this.fromPoints=function(a){var b,c;for(this.reset(),b=0,c=a.length;c>b;b+=1)this.merge(a[b]);return this},this.fromSphere=function(a){var b=a.center,c=a.radius;return this.min.copy(b).sub(c),this.max.copy(b).add(c),this},this.reset=function(){var b=a.Vector3;return this.min.copy(b.INF),this.max.copy(b.N_INF),this},this.empty=function(){var a=this.min,b=this.max;return b.x<=a.x||b.y<=a.y||b.z<=a.z},this.center=function(b){var c=b||a.makeVector3();return c.copy(this.min).add(this.max).mul(.5)},this.size=function(b){var c=b||a.makeVector3();return c.copy(this.max).sub(this.min)},this.cornerPoints=function(){var b=function(b,c,d,e,f){return b[c]||(b[c]=a.makeVector3()),b[c].set(d,e,f),c+1};return function(a){var c=this.min,d=this.max,e=c.x,f=c.y,g=c.z,h=d.x,i=d.y,j=d.z,k=0;return a=a||[],k=b(a,k,e,f,g),k=b(a,k,e,f,j),k=b(a,k,e,i,g),k=b(a,k,e,i,j),k=b(a,k,h,f,g),k=b(a,k,h,f,j),k=b(a,k,h,i,g),k=b(a,k,h,i,j),a.length=k,a}}(),this.translate=function(a){return this.min.add(a),this.max.add(a),this},this.transform=function(){var a=[];return function(b){var c,d;for(this.cornerPoints(a),c=0,d=a.length;d>c;c+=1)a[c].transform(b);return this.fromPoints(a)}}(),this.merge=function(){var c=[],d=function(a,b){var c=a.min,d=a.max,e=b.x,f=b.y,g=b.z;c.x>e&&(c.x=e),c.y>f&&(c.y=f),c.z>g&&(c.z=g),d.x<e&&(d.x=e),d.y<f&&(d.y=f),d.z<g&&(d.z=g)};return c[b.POINT]=function(a){d(this,a)},c[b.SEGMENT]=function(a){d(this,a.start),d(this,a.end)},c[b.TRIANGLE]=function(a){d(this,a.a),d(this,a.b),d(this,a.c)},c[b.AABOX]=function(a){d(this,a.min),d(this,a.max)},c[b.SPHERE]=function(){var b=a.makeVector3();return function(a){var c=a.center,e=a.radius;d(this,b.copy(c).add(e)),d(this,b.copy(c).sub(e))}}(),function(a){var b=a&&a._type,d=b&&c[b()];if(!d)throw new Error("unsupported object type");return d.call(this,a),this}}(),this.equal=function(a){return a.min.equal(this.min)&&a.max.equal(this.max)}},B.Math.AABox=function(a,b){var c=B.Math.Vector3;this.min=a?a.clone():c.INF.clone(),this.max=b?b.clone():c.N_INF.clone()},B.Math.AABox.prototype=new B.Math.AABoxProto,B.Math.SphereProto=function(){var a=B.Math,b=a.Type;this._type=function(){return b.SPHERE},this.clone=function(){return a.makeSphere(this.center,this.radius)},this.copy=function(a){return this.center.copy(a.center),this.radius=a.radius,this},this.set=function(a,b){return this.center.copy(a),this.radius=b,this},this.fromArray=function(a,b){return b=b||0,b=this.center.fromArray(a,b),this.radius=a[b],b+1},this.toArray=function(a,b){return b=b||0,b=this.center.toArray(a,b),a[b]=this.radius,b+1},this.fromPoints=function(){var b=Math.min,c=Math.max,d=a.makeVector3(),e=a.makeVector3();return function(f){var g,h,i=f.length;if(i>0){for(d.copy(a.Vector3.INF),e.copy(a.Vector3.N_INF),h=0;i>h;h+=1)g=f[h],e.x=c(e.x,g.x),e.y=c(e.y,g.y),e.z=c(e.z,g.z),d.x=b(d.x,g.x),d.y=b(d.y,g.y),d.z=b(d.z,g.z);this.center.copy(e).sub(d).mul(.5),this.radius=this.center.length(),this.center.add(d)}return this}}(),this.fromAABox=function(a){return this.radius=.5*a.size(this.center).length(),a.center(this.center),this},this.reset=function(){return this.center.copy(a.Vector3.ZERO),this.radius=0,this},this.empty=function(){return this.radius<=0},this.translate=function(a){return this.center.add(a),this},this.transform=function(){var b=a.makeVector3();return function(a){return this.center.transform(a),this.radius*=Math.max(Math.max(a.getAxisX(b).length(),a.getAxisY(b).length()),a.getAxisZ(b).length()),this}}(),this.merge=function(){var c=[],d=a.makeVector3(),e=a.makeVector3();return c[b.POINT]=function(a){var b=d.copy(a).sub(this.center).length();b>this.radius&&(this.center.add(d.mul(.5)),this.radius+=.5*b)},c[b.SEGMENT]=function(a){var b=this.center,c=this.radius;this.fromPoints([d.copy(b).add(c),e.copy(b).sub(c),a.start,a.end])},c[b.TRIANGLE]=function(a){var b=this.center,c=this.radius;this.fromPoints([d.copy(b).add(c),e.copy(b).sub(c),a.a,a.b,a.c])},c[b.AABOX]=function(){var a=[];return function(b){var c=this.center,f=this.radius;b.cornerPoints(a),a.push(d.copy(c).add(f)),a.push(e.copy(c).sub(f)),this.fromPoints(a)}}(),c[b.SPHERE]=function(){var b=a.makeVector3(),c=a.makeVector3(),d=a.makeVector3();return function(a){var e=this.center,f=a.center,g=this.radius,h=a.radius,i=b.copy(f).sub(e).length();h>=i+g?this.copy(a):i+h>g&&(b.mul(1/i),c.copy(b).mul(h).add(f),d.copy(b).negate().mul(g).add(e),e.copy(d).sub(c).mul(.5),this.radius=e.length(),e.add(c))}}(),function(a){var b=a&&a._type,d=b&&c[b()];if(!d)throw new Error("unsupported object type");return d.call(this,a),this}}(),this.equal=function(a){return a.center.equal(this.center)&&a.radius===this.radius}},B.Math.Sphere=function(a,b){this.center=a||B.Math.Vector3.ZERO.clone(),this.radius=b||0},B.Math.Sphere.prototype=new B.Math.SphereProto,B.Math.FrustumProto=function(){var a=B.Math,b=a.EPSILON,c=Math.abs;this.clone=function(){return a.makeFrustum(this.left,this.right,this.top,this.bottom,this.near,this.far)},this.copy=function(a){return this.left.copy(a.left),this.right.copy(a.right),this.top.copy(a.top),this.bottom.copy(a.bottom),this.near.copy(a.near),this.far.copy(a.far),this},this.set=function(a,b,c,d,e,f){return this.left.copy(a),this.right.copy(b),this.top.copy(c),this.bottom.copy(d),this.near.copy(e),this.far.copy(f),this},this.fromArray=function(a,b){return b=b||0,b=this.left.fromArray(a,b),b=this.right.fromArray(a,b),b=this.top.fromArray(a,b),b=this.bottom.fromArray(a,b),b=this.near.fromArray(a,b),b=this.far.fromArray(a,b)},this.toArray=function(a,b){return b=b||0,b=this.left.toArray(a,b),b=this.right.toArray(a,b),b=this.top.toArray(a,b),b=this.bottom.toArray(a,b),b=this.near.toArray(a,b),b=this.far.toArray(a,b)},this.fromMatrix=function(){var b=a.makeVector3();return function(a){var c=a.m,d=c[0],e=c[1],f=c[2],g=c[3],h=c[4],i=c[5],j=c[6],k=c[7],l=c[8],m=c[9],n=c[10],o=c[11],p=c[12],q=c[13],r=c[14],s=c[15];return this.left.set(b.set(g+d,k+h,o+l),-(s+p)).normalize(),this.right.set(b.set(g-d,k-h,o-l),-(s-p)).normalize(),this.top.set(b.set(g-e,k-i,o-m),-(s-q)).normalize(),this.bottom.set(b.set(g+e,k+i,o+m),-(s+q)).normalize(),this.near.set(b.set(g+f,k+j,o+n),-(s+r)).normalize(),this.far.set(b.set(g-f,k-j,o-n),-(s-r)).normalize(),this}}(),this.cornerPoints=function(){var d=a.makeVector3(),e=function(e,f,g,h,i){var j,k=e.normal,l=e.distance,m=f.normal,n=f.distance,o=g.normal,p=g.distance;if(h[i]||(h[i]=a.makeVector3()),j=h[i].crossVectors(m,o).dot(k),c(j)<b)throw new Error("Frustum has invalid set of planes");h[i].mul(l).add(d.crossVectors(k,m).mul(p)).add(d.crossVectors(o,k).mul(n)).div(j)};return function(a){var b=this.near,c=this.far,d=this.top,f=this.bottom,g=this.left,h=this.right;return a=a||[],e(b,d,g,a,0),e(b,d,h,a,1),e(b,f,g,a,2),e(b,f,h,a,3),e(c,d,g,a,4),e(c,d,h,a,5),e(c,f,g,a,6),e(c,f,h,a,7),a}}(),this.contain=function(a){return this.left.distanceTo(a)>=0&&this.right.distanceTo(a)>=0&&this.top.distanceTo(a)>=0&&this.bottom.distanceTo(a)>=0&&this.near.distanceTo(a)>=0&&this.far.distanceTo(a)>=0},this.equal=function(a){return this.left.equal(a.left)&&this.right.equal(a.right)&&this.top.equal(a.top)&&this.bottom.equal(a.bottom)&&this.near.equal(a.near)&&this.far.equal(a.far)}},B.Math.Frustum=function(a,b,c,d,e,f){var g=B.Math.Plane;this.left=a||g.X.clone(),this.right=b||g.N_X.clone(),this.top=c||g.N_Y.clone(),this.bottom=d||g.Y.clone(),this.near=e||g.Z.clone(),this.far=f||g.N_Z.clone()},B.Math.Frustum.prototype=new B.Math.FrustumProto,B.Render={},B.Render.Mask={R:1,G:2,B:4,A:8,RGB:7,RGBA:15},B.Render.applyColorMask=function(a,b){var c=B.Render.Mask,d=b&c.R,e=b&c.G,f=b&c.B,g=b&c.A;a.colorMask(d,e,f,g)},B.Render.makeDevice=function(a,b,c,d){return new B.Render.Device(a,b,c,d)},B.Render.isPowerOfTwo=function(a){var b=Math.log(a)/Math.LN2;return b-Math.floor(b)===0},B.Render.toPowerOfTwo=function(a){var b=Math.log(a)/Math.LN2;return Math.pow(2,Math.ceil(b))},B.Render.genQuad=function(){var a=B.Render;return function(b,c,d,e,f){var g=.5*(c||1),h=-g,i=.5*(d||1),j=-i,k=e||1,l=f||1,m=[h,j,0,0,0,1,1,0,0,0,0,g,j,0,0,0,1,1,0,0,k,0,g,i,0,0,0,1,1,0,0,k,l,h,i,0,0,0,1,1,0,0,0,l],n=[0,1,2,2,3,0];return b.makeMesh().attribute("position",a.Attribute.POSITION).attribute("normal",a.Attribute.NORMAL).attribute("tangent",a.Attribute.TANGENT).attribute("uv",a.Attribute.UV).vertices(m).indices(n)}}(),B.Render.genBox=function(){var a=B.Render;return function(b,c,d,e,f,g){var h=.5*(c||1),i=-h,j=.5*(d||1),k=-j,l=.5*(e||1),m=-l,n=f||1,o=g||1,p=[i,k,l,-1,0,0,0,0,-1,0,0,i,k,m,-1,0,0,0,0,-1,n,0,i,j,m,-1,0,0,0,0,-1,n,o,i,j,l,-1,0,0,0,0,-1,0,o,i,k,m,0,-1,0,-1,0,0,n,0,i,k,l,0,-1,0,-1,0,0,n,o,h,k,l,0,-1,0,-1,0,0,0,o,h,k,m,0,-1,0,-1,0,0,0,0,i,k,m,0,0,-1,1,0,0,0,0,h,k,m,0,0,-1,1,0,0,n,0,h,j,m,0,0,-1,1,0,0,n,o,i,j,m,0,0,-1,1,0,0,0,o,h,k,m,1,0,0,0,0,1,0,0,h,k,l,1,0,0,0,0,1,n,0,h,j,l,1,0,0,0,0,1,n,o,h,j,m,1,0,0,0,0,1,0,o,i,j,m,0,1,0,1,0,0,0,0,h,j,m,0,1,0,1,0,0,n,0,h,j,l,0,1,0,1,0,0,n,o,i,j,l,0,1,0,1,0,0,0,o,h,k,l,0,0,1,-1,0,0,0,0,i,k,l,0,0,1,-1,0,0,n,0,i,j,l,0,0,1,-1,0,0,n,o,h,j,l,0,0,1,-1,0,0,0,o],q=[0,2,1,2,0,3,4,6,5,6,4,7,8,10,9,10,8,11,12,14,13,14,12,15,16,18,17,18,16,19,20,22,21,22,20,23];return b.makeMesh().attribute("position",a.Attribute.POSITION).attribute("normal",a.Attribute.NORMAL).attribute("tangent",a.Attribute.TANGENT).attribute("uv",a.Attribute.UV).vertices(p).indices(q)}}(),B.Render.genSphere=function(){var a=B.Render,b=Math.PI,c=.5*b,d=2*b,e=Math.cos,f=Math.sin;return function(b,g,h,i,j){var k,l,m,n,o,p,q,r,s,t,u,v=[],w=[],x=g||1,y=h||32,z=i||1,A=j||1;for(l=0,m=2*y;m>=l;l+=1)for(o=0,p=y;p>=o;o+=1)k=l*d/m,n=o*d/p,q=c+n,r=f(k),s=e(k),t=f(n),u=e(n),v.push(x*r*t,x*r*u,x*s,r*t,r*u,s,f(q),e(q),0,z*n/y,A*(1-k/y));for(q=y+1,l=0,m=y;m>=l;l+=1)for(o=0,p=y;p>=o;o+=1)k=l+1,n=o+1,w.push(l*q+o,l*q+n,k*q+n),w.push(l*q+o,k*q+n,k*q+o);return b.makeMesh().attribute("position",a.Attribute.POSITION).attribute("normal",a.Attribute.NORMAL).attribute("tangent",a.Attribute.TANGENT).attribute("uv",a.Attribute.UV).vertices(v).indices(w)}}(),B.Render.Error=function(a,b){this.stack=(new Error).stack,this.name=b||"B.Render.Error",this.message=a},B.Render.Error.prototype=Error.prototype,B.Render.GLErrorProto=function(){},B.Render.GLErrorProto.prototype=B.Render.Error.prototype,B.Render.GLError=function(a,b){B.Render.Error.call(this,"Internal WebGL error: "+a,"B.Render.GLError"),this.code=b},B.Render.GLError.prototype=new B.Render.GLErrorProto,B.Render.checkGLError=function(a,b){var c=a.getError();if(c!==a.NO_ERROR&&c!==a.CONTEXT_LOST_WEBGL)throw new B.Render.GLError(b,c)},B.Render.checkGLFramebufferStatus=function(a,b){var c=a.checkFramebufferStatus(a.FRAMEBUFFER);if(c!==a.FRAMEBUFFER_COMPLETE)throw new B.Render.GLError(b,c)},B.Render.Attribute={UINT:1,FLOAT:2,VECTOR2:3,VECTOR3:4,VECTOR4:5,POSITION:6,NORMAL:7,TANGENT:8,UV:9,COLOR:10},B.Render.attributeByteSize=function(a){var b=B.Render.Attribute;switch(a){case b.UINT:return 4;case b.FLOAT:return 4;case b.VECTOR2:return 8;case b.VECTOR3:return 12;case b.VECTOR4:return 16;case b.POSITION:return 12;case b.NORMAL:return 12;case b.TANGENT:return 12;case b.UV:return 8;case b.COLOR:return 4}return 0},B.Render.checkAttributes=function(a){var b,c,d=B.Render.Attribute,e=0,f=0,g=0;if(!a)return!1;for(b in a)switch(c=a[b]){case d.UINT:case d.FLOAT:case d.VECTOR2:case d.VECTOR3:case d.VECTOR4:case d.TANGENT:case d.UV:case d.COLOR:e+=1;break;case d.POSITION:e+=1,f+=1;break;case d.NORMAL:e+=1,g+=1;break;default:return!1}return e>0&&2>f&&2>g},B.Render.resolveAttributeAlias=function(a){var b=B.Render.Attribute;switch(a){case b.POSITION:case b.NORMAL:case b.TANGENT:return b.VECTOR3;case b.UV:return b.VECTOR2;case b.COLOR:return b.UINT}return a},B.Render.fromGLAttributeActiveInfo=function(a,b){var c=B.Render.Attribute;switch(b.type){case a.UNSIGNED_INT:return c.UINT;case a.FLOAT:return c.FLOAT;case a.FLOAT_VEC2:return c.VECTOR2;case a.FLOAT_VEC3:return c.VECTOR3;case a.FLOAT_VEC4:return c.VECTOR4}},B.Render.Index={USHORT:1,UINT:2},B.Render.indexByteSize=function(a){var b=B.Render.Index;switch(a){case b.USHORT:return 2;case b.UINT:return 4}return 0},B.Render.toGLIndex=function(a,b){var c=B.Render.Index;switch(b){case c.USHORT:return a.UNSIGNED_SHORT;case c.UINT:return a.UNSIGNED_INT}},B.Render.Primitive={POINT:1,LINE:2,TRIANGLE:3},B.Render.indicesPerPrimitive=function(a){var b=B.Render.Primitive;switch(a){case b.POINT:return 1;case b.LINE:return 2;case b.TRIANGLE:return 3}return 0},B.Render.toGLPrimitive=function(a,b){var c=B.Render.Primitive;switch(b){case c.POINT:return a.POINTS;case c.LINE:return a.LINES;case c.TRIANGLE:return a.TRIANGLES}},B.Render.Usage={STATIC:1,DYNAMIC:2},B.Render.MeshProto=function(){var a=B.Math,b=B.Render,c=b.Usage,d=b.Index,e=function(a,b){var c=B.Render.Usage;switch(b){case c.STATIC:return a.STATIC_DRAW;case c.DYNAMIC:return a.DYNAMIC_DRAW}};this.device=function(){return this._device},this.attributes=function(){return this._attributesNames},this.attribute=function(a,b){var c,d,e=this._attributes,f=this._attributesNames;return 1===arguments.length?this._attributes[a]||null:(c=f.indexOf(a),d=-1!==c,"string"==typeof b?d&&(f.splice(c,1,b),e[b]=e[a],delete e[a]):null===b?d&&(f.splice(c,1),delete e[a]):(d||f.push(a),e[a]=b),this._adjustAttributes(),this)},this.vertexCount=function(){return this._vertexCount},this.vertices=function(a,d){var f=this._gl;if(0===arguments.length)return this._vertexSource;if("number"==typeof a){if(1>a)throw new b.Error("can't set Mesh vertex data - vertex count is 0");this._vertexSource=null,this._vertexCount=a}else if(Array.isArray(a))this._vertexSource=new Float32Array(a);else{if(!(a instanceof Float32Array))throw new b.Error("can't set Mesh vertex data - invalid source type");this._vertexSource=a}return this._vertexUsage=d||c.STATIC,this._adjustAttributes(),f.bindBuffer(f.ARRAY_BUFFER,this._glVertexBuffer),f.bufferData(f.ARRAY_BUFFER,this._vertexSource||this._glStride*this._vertexCount,e(f,this._vertexUsage)),b.checkGLError(f,"can't set Mesh vertices"),this._vertexUsage===c.DYNAMIC&&(this._vertexSource=null),this},this.updateVertices=function(a,d){var e=this._gl,f=d?d*Float32Array.BYTES_PER_ELEMENT:0,g=this._glStride*this._vertexCount;if(!g)throw new b.Error("can't update Mesh vertex data - vertices must be set before update");if(a){if(Array.isArray(a))a=new Float32Array(a);else if(!(a instanceof Float32Array))throw new b.Error("can't update Mesh vertex data - invalid source type");if(f+a.byteLength>g)throw new b.Error("can't update Mesh vertex data - source data is out of range");this._vertexSource&&this._vertexUsage!==c.DYNAMIC&&this._vertexSource.set(a,d)}else a=this._vertexSource;return a&&(e.bindBuffer(e.ARRAY_BUFFER,this._glVertexBuffer),e.bufferSubData(e.ARRAY_BUFFER,f,a),b.checkGLError(e,"can't update Mesh vertices")),this},this.flushVertices=function(){return this._vertexSource=null,this},this.index=function(){return this._index},this.indexCount=function(){return this._indexCount},this.indices=function(a,f){var g=this._gl;if(0===arguments.length)return this._indexSource;if(this._index=d.USHORT,"number"==typeof a){if(1>a)throw new b.Error("can't set Mesh index data - index count is 0");this._indexSource=null}else if(Array.isArray(a))this._indexSource=new Uint16Array(a);else if(a instanceof Uint16Array)this._indexSource=a;else{if(!(a instanceof Uint32Array))throw new b.Error("can't set Mesh index data - invalid source type");this._indexSource=a,this._index=d.UINT}if(this._index===d.UINT&&!this._device.caps().indexUInt)throw new b.Error("can't set Mesh index data - 32-bit indices are not supported");return this._glIndex=b.toGLIndex(g,this._index),this._indexCount=a.length||a,this._indexUsage=f||c.STATIC,this._adjustPrimitives(),g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,this._glIndexBuffer),g.bufferData(g.ELEMENT_ARRAY_BUFFER,this._indexSource||b.indexByteSize(this._index)*this._indexCount,e(g,this._indexUsage)),b.checkGLError(g,"can't set Mesh indices"),this._indexUsage===c.DYNAMIC&&(this._indexSource=null),this},this.updateIndices=function(a,e){var f=this._gl,g=this._index,h=b.indexByteSize(g),i=h*this._indexCount,j=e?e*h:0;if(!i)throw new b.Error("can't update Mesh index data - indices must be set before update");if(a){if(Array.isArray(a))a=g===d.USHORT?new Uint16Array(a):new Uint32Array(a);else if(g===d.USHORT&&!(a instanceof Uint16Array)||g===d.UINT&&!(a instanceof Uint32Array))throw new b.Error("can't update Mesh index data - invalid source type");if(j+a.byteLength>i)throw new b.Error("can't update Mesh index data - source data is out of range");this._indexSource&&this._indexUsage!==c.DYNAMIC&&this._indexSource.set(a,e)}else a=this._indexSource;return a&&(f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,this._glIndexBuffer),f.bufferSubData(f.ELEMENT_ARRAY_BUFFER,j,this._indexSource),b.checkGLError(f,"can't update Mesh indices")),this},this.flushIndices=function(){return this._indexSource=null,this},this.primitive=function(a){return 0===arguments.length?this._primitive:(this._primitive=a,this._adjustPrimitives(),this)},this.primitiveCount=function(){return this._primitiveCount},this.bounds=function(a){return 0===arguments.length?this._bounds:(this._bounds.copy(a),this)},this.computeBounds=function(){var c=a.makeVector3();return function(){var a,d,e,f,g,h=this._attributes,i=0,j=this._bounds,k=this._vertexSource,l=0;if(!k)throw new b.Error("can't compute Mesh bounds - vertex data source is not linked");for(a in h)if(h[a]===b.Attribute.POSITION){i=a;break}if(!i)throw new b.Error("can't compute Mesh bounds - POSITION attribute is not found");for(j.reset(),f=this._glStride/Float32Array.BYTES_PER_ELEMENT,g=this._glOffsets[i]/Float32Array.BYTES_PER_ELEMENT,d=0,e=this._vertexCount;e>d;d+=1)l=d*f+g,c.set(k[l],k[l+1],k[l+2]),j.merge(c);return this}}(),this.free=function(){var a=this._gl;this._device._removeMesh(this),a.deleteBuffer(this._glVertexBuffer),a.deleteBuffer(this._glIndexBuffer),B.Std.freeObject(this)},this._make=function(){var a=this._gl;this._glVertexBuffer=a.createBuffer(),this._glIndexBuffer=a.createBuffer(),b.checkGLError(a,"can't make Mesh buffers")},this._bind=function(){var a=b.Attribute,c=[],d=[];return c[a.UINT]=function(a,b,c,d){a.vertexAttribPointer(b,4,a.UNSIGNED_BYTE,!0,c,d)},c[a.FLOAT]=function(a,b,c,d){a.vertexAttribPointer(b,1,a.FLOAT,!1,c,d)},c[a.VECTOR2]=function(a,b,c,d){a.vertexAttribPointer(b,2,a.FLOAT,!1,c,d)},c[a.VECTOR3]=function(a,b,c,d){a.vertexAttribPointer(b,3,a.FLOAT,!1,c,d)},c[a.VECTOR4]=function(a,b,c,d){a.vertexAttribPointer(b,4,a.FLOAT,!1,c,d)},d[a.FLOAT]=function(a,b){a.vertexAttrib1f(b,0)},d[a.VECTOR2]=function(a,b){a.vertexAttrib2f(b,0,0)},d[a.VECTOR3]=function(a,b){a.vertexAttrib3f(b,0,0,0)},d[a.VECTOR4]=function(a,b){a.vertexAttrib4f(b,0,0,0,0)},function(e){var f,g,h,i,j,k=this._gl,l=this._attributes,m=this._glOffsets,n=this._glStride,o=0;k.bindBuffer(k.ARRAY_BUFFER,this._glVertexBuffer);for(f in e)g=e[f],i=b.resolveAttributeAlias(l[f]),h=g.type,j=g.location,i===h||i===a.UINT&&h===a.VECTOR4?(c[i](k,j,n,m[f]),o+=1):d[h](k,j);if(!o)throw new b.Error("can't bind Mesh - neither attributes matched");k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,this._glIndexBuffer)}}(),this._draw=function(){this._gl.drawElements(this._glPrimitive,this._indexCount,this._glIndex,0)},this._restore=function(){var a=this._vertexCount,b=this._indexCount;this._make(),a&&this.vertices(this._vertexSource||a,this._vertexUsage),b&&this.indices(this._indexSource||b,this._indexUsage)},this._adjustAttributes=function(){var a,c,d,e=this._attributes,f=this._attributesNames,g=0;if(!b.checkAttributes(e))throw new b.Error("can't adjust Mesh - invalid vertex attributes");for(this._glOffsets={},a=0,c=f.length;c>a;a+=1)d=f[a],this._glOffsets[d]=g,g+=b.attributeByteSize(e[d]);this._glStride=g,this._vertexSource&&(this._vertexCount=this._vertexSource.byteLength/this._glStride)},this._adjustPrimitives=function(){this._primitiveCount=this._indexCount/b.indicesPerPrimitive(this._primitive),this._glPrimitive=b.toGLPrimitive(this._gl,this._primitive)}},B.Render.Mesh=function(a){this._device=a,this._attributes={},this._attributesNames=[],this._vertexUsage=0,this._vertexCount=0,this._vertexSource=null,this._index=0,this._indexUsage=0,this._indexCount=0,this._indexSource=null,this._primitive=B.Render.Primitive.TRIANGLE,this._primitiveCount=0,this._bounds=B.Math.makeAABox(),this._gl=a._gl,this._glOffsets={},this._glStride=0,this._glPrimitive=0,this._glIndex=0,this._glVertexBuffer=null,this._glIndexBuffer=null,this._id=-1,this._make()},B.Render.Mesh.prototype=new B.Render.MeshProto,B.Render.Format={A:1,RGB:2,RGBA:3,RGB_DXT1:4,RGBA_DXT5:5,A_F16:6,RGB_F16:7,RGBA_F16:8,A_F32:9,RGB_F32:10,RGBA_F32:11,DEPTH:12,DEPTH_STENCIL:13},B.Render.formatBitSize=function(a){var b=B.Render,c=b.Format;switch(a){case c.A:return 8;case c.RGB:return 24;case c.RGBA:return 32;case c.RGB_DXT1:return 4;case c.RGBA_DXT5:return 8;case c.A_F16:return 16;case c.RGB_F16:return 48;case c.RGBA_F16:return 64;case c.A_F32:return 32;case c.RGB_F32:return 96;case c.RGBA_F32:return 128;case c.DEPTH:return 16;case c.DEPTH_STENCIL:return 32}return 0},B.Render.formatBlockByteSize=function(a){var b=B.Render.Format;switch(a){case b.RGB_DXT1:return 8;case b.RGBA_DXT5:return 16}return 0},B.Render.formatBlockTexelSize=function(a){var b=B.Render.Format;switch(a){case b.RGB_DXT1:case b.RGBA_DXT5:return 4}return 0},B.Render.imagePitch=function(a,b){var c,d=B.Render,e=d.Format;switch(a){case e.A:case e.RGB:case e.RGBA:case e.A_F16:case e.RGB_F16:case e.RGBA_F16:case e.A_F32:case e.RGB_F32:case e.RGBA_F32:case e.DEPTH:case e.DEPTH_STENCIL:return b*d.formatBitSize(a)/8;case e.RGB_DXT1:case e.RGBA_DXT5:return c=d.formatBlockTexelSize(a),Math.max(c,b)/c*d.formatBlockByteSize(a)}return 0},B.Render.imageRows=function(a,b){var c,d=B.Render,e=d.Format;switch(a){case e.A:case e.RGB:case e.RGBA:case e.A_F16:case e.RGB_F16:case e.RGBA_F16:case e.A_F32:case e.RGB_F32:case e.RGBA_F32:case e.DEPTH:case e.DEPTH_STENCIL:return b;
case e.RGB_DXT1:case e.RGBA_DXT5:return c=d.formatBlockTexelSize(a),Math.max(c,b)/c}return 0},B.Render.imageByteSize=function(a,b,c){return B.Render.imagePitch(a,b)*B.Render.imageRows(a,c)},B.Render.checkColorFormat=function(a,b,c){var d=B.Render.Format,e=a.caps();switch(b){case d.A:case d.RGB:case d.RGBA:return!0;case d.RGB_DXT1:case d.RGBA_DXT5:return!c&&e.textureDXT;case d.A_F16:case d.RGB_F16:case d.RGBA_F16:return c?e.colorTargetFloat16:e.textureFloat16;case d.A_F32:case d.RGB_F32:case d.RGBA_F32:return c?e.colorTargetFloat32:e.textureFloat32}return!1},B.Render.checkDepthFormat=function(a,b){var c=B.Render.Format;switch(b){case c.DEPTH:case c.DEPTH_STENCIL:return!0}return!1},B.Render.checkColorFormatDataSource=function(a,b){var c=B.Render.Format;switch(a){case c.A:case c.RGB:case c.RGBA:case c.RGB_DXT1:case c.RGBA_DXT5:return b instanceof Uint8Array;case c.A_F32:case c.RGB_F32:case c.RGBA_F32:return b instanceof Float32Array}return!1},B.Render.toGLColorFormat=function(a,b){var c=B.Render,d=c.Format,e=a._gl,f=a._ext("compressed_texture_s3tc");switch(b){case d.A:case d.A_F16:case d.A_F32:return e.ALPHA;case d.RGB:case d.RGB_F16:case d.RGB_F32:return e.RGB;case d.RGBA:case d.RGBA_F16:case d.RGBA_F32:return e.RGBA;case d.RGB_DXT1:return f&&f.COMPRESSED_RGB_S3TC_DXT1_EXT;case d.RGBA_DXT5:return f&&f.COMPRESSED_RGBA_S3TC_DXT5_EXT}},B.Render.toGLDepthFormat=function(a,b,c){var d=B.Render,e=d.Format,f=a._gl;switch(b){case e.DEPTH:return c?f.DEPTH_COMPONENT:f.DEPTH_COMPONENT16;case e.DEPTH_STENCIL:return f.DEPTH_STENCIL}},B.Render.toGLType=function(a,b){var c=B.Render.Format,d=a._gl,e=a._ext("depth_texture"),f=a._ext("texture_half_float");switch(b){case c.A:case c.RGB:case c.RGBA:return d.UNSIGNED_BYTE;case c.A_F16:case c.RGB_F16:case c.RGBA_F16:return f&&f.HALF_FLOAT_OES;case c.A_F32:case c.RGB_F32:case c.RGBA_F32:return d.FLOAT;case c.DEPTH:return d.UNSIGNED_SHORT;case c.DEPTH_STENCIL:return e&&e.UNSIGNED_INT_24_8_WEBGL}},B.Render.DepthProto=function(){var a=B.Render;this.device=function(){return this._device},this.width=function(){return this._width},this.height=function(){return this._height},this.size=function(){return this._size},this.format=function(){return this._format},this.readable=function(){return this._readable},this.free=function(){this._device._removeDepth(this),this._readable?this._gl.deleteTexture(this._glHandle):this._gl.deleteRenderbuffer(this._glHandle),B.Std.freeObject(this)},this._make=function(){var b=a.Format,c=function(a,c){switch(c){case b.DEPTH:return a.DEPTH_ATTACHMENT;case b.DEPTH_STENCIL:return a.DEPTH_STENCIL_ATTACHMENT}};return function(){var b=this._device,d=b._gl,e=this._format,f=this._width,g=this._height;if(this._readable&&!this._device.caps().readableDepth)throw new a.Error("readable Depth buffers are not supported (check device.caps().readableDepth)");if(!a.checkDepthFormat(b,e))throw new a.Error("can't make Depth - unsupported format");if(!f||!g)throw new a.Error("can't make Depth - invalid size argument");if(!a.isPowerOfTwo(f)||!a.isPowerOfTwo(g))throw new a.Error("can't make Depth - size is not power of 2");if(Math.max(f,g)>b.caps().depthMaxSize)throw new a.Error("can't make Depth - unsupported size (greater then device.caps().depthMaxSize)");this._glAttachment=c(d,this._format),this._adjust()}}(),this._adjust=function(){var b,c=this._gl,d=this._width,e=this._height,f=a.toGLDepthFormat(this._device,this._format,this._readable),g=a.toGLType(this._device,this._format);this._readable?(b=c.TEXTURE_2D,this._glHandle=c.createTexture(),c.bindTexture(b,this._glHandle),c.texParameteri(b,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(b,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(b,c.TEXTURE_WRAP_S,c.REPEAT),c.texParameteri(b,c.TEXTURE_WRAP_T,c.REPEAT),c.texImage2D(b,0,f,d,e,0,f,g,null)):(b=c.RENDERBUFFER,this._glHandle=c.createRenderbuffer(),c.bindRenderbuffer(b,this._glHandle),c.renderbufferStorage(b,f,d,e)),a.checkGLError(c,"can't adjust Depth")},this._attach=function(){var a=this._gl;this._readable?a.framebufferTexture2D(a.FRAMEBUFFER,this._glAttachment,a.TEXTURE_2D,this._glHandle,0):a.framebufferRenderbuffer(a.FRAMEBUFFER,this._glAttachment,a.RENDERBUFFER,this._glHandle)},this._detach=function(){var a=this._gl;this._readable?a.framebufferTexture2D(a.FRAMEBUFFER,this._glAttachment,a.TEXTURE_2D,null,0):a.framebufferRenderbuffer(a.FRAMEBUFFER,this._glAttachment,a.RENDERBUFFER,null)},this._restore=function(){this._adjust()}},B.Render.Depth=function(a,b,c,d,e){this._device=a,this._width=c,this._height=d,this._size=B.Math.makeVector2(c,d),this._format=b,this._readable=e||!1,this._gl=a._gl,this._glAttachment=0,this._glHandle=null,this._id=-1,this._make()},B.Render.Depth.prototype=new B.Render.DepthProto,B.Render.MipProto=function(){this.device=function(){return this._device},this.texture=function(){return this._texture},this.index=function(){return this._index},this.count=function(){return this._count},this.face=function(){return this._face},this.faceCount=function(){return this._faceCount},this.width=function(){return this._width},this.height=function(){return this._height},this.size=function(){return this._size},this.format=function(){return this._format},this.source=function(a){return 0===arguments.length?this._source:(this._texture._upload(this._face,this._index,a),this._source=a||null,this)},this.flush=function(){this._source=null},this.pitch=function(){return this._pitch},this.rows=function(){return this._rows},this.byteSize=function(){return this._byteSize},this._attach=function(a){this._texture._attach(a,this._face,this._index)},this._detach=function(a){this._texture._detach(a)},this._restore=function(){this._texture._upload(this._face,this._index,this._source)}},B.Render.Mip=function(a,b,c,d){var e=B.Render;this._device=a,this._texture=b,this._index=c,this._count=b.mipCount(),this._face=d,this._faceCount=b.faceCount(),this._width=e.Mip.calcSize(b.width(),c),this._height=e.Mip.calcSize(b.height(),c),this._size=B.Math.makeVector2(this._width,this._height),this._format=b.format(),this._pitch=e.imagePitch(this._format,this._width),this._rows=e.imageRows(this._format,this._height),this._byteSize=this._pitch*this._rows,this._source=null},B.Render.Mip.prototype=new B.Render.MipProto,B.Render.Mip.calcMaxCount=function(a){return Math.max(0,Math.log(a))/Math.LN2+1},B.Render.Mip.calcSize=function(a,b){return Math.pow(2,Math.max(0,Math.log(a)/Math.LN2-b))},B.Render.CubeFace={POSITIVE_X:0,NEGATIVE_X:1,POSITIVE_Y:2,NEGATIVE_Y:3,POSITIVE_Z:4,NEGATIVE_Z:5,COUNT:6},B.Render.TextureProto=function(){var a=B.Render,b=a.CubeFace,c=function(a,c,d){if(1===c)return a.TEXTURE_2D;if(void 0===d)return a.TEXTURE_CUBE_MAP;switch(d){case b.POSITIVE_X:return a.TEXTURE_CUBE_MAP_POSITIVE_X;case b.NEGATIVE_X:return a.TEXTURE_CUBE_MAP_NEGATIVE_X;case b.POSITIVE_Y:return a.TEXTURE_CUBE_MAP_POSITIVE_Y;case b.NEGATIVE_Y:return a.TEXTURE_CUBE_MAP_NEGATIVE_Y;case b.POSITIVE_Z:return a.TEXTURE_CUBE_MAP_POSITIVE_Z;case b.NEGATIVE_Z:return a.TEXTURE_CUBE_MAP_NEGATIVE_Z}},d=function(a,b){var c,d,e,f,g,h,i=a._mips;for(c=0,d=a._faceCount;d>c;c+=1)for(h=i[c],e=0,f=a._mipCount;f>e;e+=1)g=b(h[e],c,e),g&&(h[e]=g)},e=function(b,c){var e=b._device;b._mipCount=c||a.Mip.calcMaxCount(Math.max(b._width,b._height)),d(b,function(c,d,f){return c?void 0:new a.Mip(e,b,f,d)})},f=function(a,b){b.set(a.videoWidth||a.naturalWidth||a.width,a.videoHeight||a.naturalHeight||a.height)};this.device=function(){return this._device},this.width=function(){return this._width},this.height=function(){return this._height},this.size=function(){return this._size},this.format=function(){return this._format},this.mipCount=function(){return this._mipCount},this.faceCount=function(){return this._faceCount},this.mip=function(a,b){var c=this._mips[b||0];return c&&c[a||0]||null},this.buildMips=function(){var b=this._gl;return e(this),b.bindTexture(this._glTarget,this._glTexture),b.generateMipmap(this._glTarget),a.checkGLError(b,"can't build Texture mips"),this._built=!0,this},this.flush=function(){return d(this,function(a){a.flush()}),this},this.free=function(){this._device._removeTexture(this),this._gl.deleteTexture(this._glTexture),d(this,function(a){B.Std.freeObject(a)}),B.Std.freeObject(this)},this._make=function(){var g=a.Format,h=function(a,b,c,d,e,f){a._size.set(c,d),a._width=c,a._height=d,a._format=b,a._faceCount=f||1,a._mipCount=e||0},i=function(b,c,d){if(!c)throw new a.Error("can't make Texture - invalid source object");f(c,b._size),b._width=b._size.x,b._height=b._size.y,b._format=a.Format.RGBA,b._faceCount=d,b._mipCount=1},j=function(c){var d=c._device.caps(),e=c._width,f=c._height,h=Math.max(e,f),i=Math.min(e,f),j=c._format,k=c._faceCount,l=c._mipCount;if(!a.checkColorFormat(c._device,j))throw new a.Error("can't make Texture - unsupported format");if(!e||!f)throw new a.Error("can't make Texture - invalid size");if((j===g.RGB_DXT1||j===g.RGBA_DXT5)&&4>i)throw new a.Error("can't make Texture - size is less than one block");if(!a.isPowerOfTwo(e)||!a.isPowerOfTwo(f))throw new a.Error("can't make Texture - size is not power of 2");if(1!==k&&k!==b.COUNT)throw new a.Error("can't make Texture - invalid face count");if(l>a.Mip.calcMaxCount(h))throw new a.Error("can't make Texture - invalid mip count");if(1===k&&h>d.textureMaxSize)throw new a.Error("can't make Texture - unsupported size (greater then device.caps().texturesMaxSize)");if(k===b.COUNT&&h>d.cubemapMaxSize)throw new a.Error("can't make Texture - unsupported size (greater then device.caps().cubemapMaxSize)")};return function(b,f,g,k,l){var m,n,o=b,p=this._gl;for("number"==typeof b?(o=null,h(this,b,f,g,k,l)):(o=Array.isArray(o)?o:[o],i(this,o[0],o.length)),j(this),m=0,n=this._faceCount;n>m;m+=1)this._mips[m]=[];this._glTarget=c(p,this._faceCount),this._glFormat=a.toGLColorFormat(this._device,this._format),this._glType=a.toGLType(this._device,this._format),this._adjust(),e(this,this._mipCount),d(this,function(a,b){a.source(o&&o[b])})}}(),this._adjust=function(){var b=this._gl,c=this._glTarget;this._glTexture=b.createTexture(),b.bindTexture(c,this._glTexture),b.texParameteri(c,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(c,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(c,b.TEXTURE_WRAP_S,b.REPEAT),b.texParameteri(c,b.TEXTURE_WRAP_T,b.REPEAT),a.checkGLError(b,"can't adjust Texture")},this._upload=function(){var d=function(b){var c=a.Format;switch(b){case c.RGB_DXT1:case c.RGBA_DXT5:return!0}return!1},e=function(b,c,d){var e=b._gl,f=d.index(),g=b._glFormat,h=b._glType;switch(b._format){case a.Format.RGB_DXT1:g=e.RGB,h=e.UNSIGNED_BYTE;break;case a.Format.RGBA_DXT5:g=e.RGBA,h=e.UNSIGNED_BYTE}e.texImage2D(c,f,g,d.width(),d.height(),0,g,h,null)},g=function(b,c,e,f){var g=b._gl,h=e.index();if(!a.checkColorFormatDataSource(b._format,f))throw new a.Error("can't upload Mip data - invalid source type");if(f.byteLength!==e.byteSize())throw new a.Error("can't upload Mip data - invalid source byte size");g.pixelStorei(g.UNPACK_FLIP_Y_WEBGL,0),d(b._format)?g.compressedTexImage2D(c,h,b._glFormat,e.width(),e.height(),0,f):g.texImage2D(c,h,b._glFormat,e.width(),e.height(),0,b._glFormat,b._glType,f)},h=function(){var c=B.Math.makeVector2();return function(e,g,h,i){var j=e._gl,k=h.index();if(f(i,c),c.x!==h.width()||c.y!==h.height())throw new a.Error("can't upload Texture mip data - inappropriate source size");if(d(e._format))throw new a.Error("can't upload Texture mip data - only compressed data allowed");j.pixelStorei(j.UNPACK_FLIP_Y_WEBGL,e._faceCount!==b.COUNT),j.texImage2D(g,k,e._glFormat,e._glFormat,e._glType,i)}}();return function(b,d,f){var i=this._gl,j=this.mip(d,b),k=c(i,this._faceCount,b);i.bindTexture(this._glTarget,this._glTexture),f?f instanceof Uint8Array||f instanceof Float32Array?g(this,k,j,f):h(this,k,j,f):e(this,k,j),a.checkGLError(i,"can't upload Texture mip data")}}(),this._attach=function(a,b,d){var e=this._gl;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+a,c(e,this._faceCount,b),this._glTexture,d)},this._detach=function(a){var b=this._gl;b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0+a,b.TEXTURE_2D,null,0)},this._restore=function(){var a=this._built;this._adjust(),d(this,function(b,c,d){a&&0!==d||b._restore()}),a&&this.buildMips()}},B.Render.Texture=function(a,b,c,d,e,f){this._device=a,this._width=0,this._height=0,this._size=B.Math.makeVector2(),this._format=0,this._faceCount=0,this._mipCount=0,this._mips=[],this._gl=a._gl,this._glTexture=null,this._glTarget=0,this._glFormat=0,this._glType=0,this._built=!1,this._id=-1,this._make(b,c,d,e,f)},B.Render.Texture.prototype=new B.Render.TextureProto,B.Render.TargetProto=function(){var a=B.Render;this.device=function(){return this._device},this.width=function(){return this._width},this.height=function(){return this._height},this.size=function(){return this._size},this.multisamples=function(){return this._multisamples},this.color=function(b){var c,d,e=Array.isArray(b)?b:[b],f=this._color;if(0===arguments.length)return 1===f.length?f[0]:f;if(1===arguments.length&&"number"==typeof b)return f[b]||null;for(this._bind(),c=0,d=this._color.length;d>c;c+=1)this._color[c]._detach(c);for(this._color=[],c=0,d=e.length;d>c;c+=1)this._color[c]=e[c]instanceof a.Texture?e[c].mip(0):e[c];for(this._check(),c=0,d=this._color.length;d>c;c+=1)this._color[c]._attach(c);return this._validate(),this._size.copy(this._color[0].size()),this._width=this._size.x,this._height=this._size.y,this._multisamples=this._gl.getParameter(this._gl.SAMPLES),this},this.depth=function(a){return 0===arguments.length?this._depth:(this._bind(),this._depth&&this._depth._detach(),this._depth=a||null,this._check(),this._depth&&this._depth._attach(),this._validate(),this)},this.clone=function(a){var b,c,d=[],e=this._depth?this._depth.format():null;for(a=a>0?a:1,b=0,c=this._color.length;c>b;b+=1)d[b]=this._color[b].format();return this._device.makeTarget(d,e,this._width*a,this._height*a)},this.free=function(){this._device._removeTarget(this),this._gl.deleteFramebuffer(this._glFramebuffer),B.Std.freeObject(this)},this._make=function(a,b,c,d){var e,f,g=this._device,h=Array.isArray(a)?a.slice():[a];if(void 0!==c&&void 0!==d)for(b=b&&g.makeDepth(b,c,d),e=0,f=h.length;f>e;e+=1)h[e]=g.makeTexture(h[e],c,d,1).mip(0);this._glFramebuffer=g._gl.createFramebuffer(),this.color(h),this.depth(b)},this._bind=function(){var a=this._device._gl;a.bindFramebuffer(a.FRAMEBUFFER,this._glFramebuffer)},this._check=function(){var b,c,d=this._device,e=this._depth,f=this._color,g=f.length,h=e&&e.width(),i=e&&e.height();if(g>d.caps().colorTargetCount)throw new a.Error("can't assemble Target - unsupported color target count (greater than device.caps().colorTargetCount)");for(b=0;g>b;b+=1){if(c=f[b],!c)throw new a.Error("can't assemble Target - unspecified color target ["+b+"]");if(h=h||c.width(),i=i||c.height(),c.width()!==h||c.height()!==i)throw new a.Error("can't assemble Target - objects must have same size");if(!a.checkColorFormat(d,c.format(),!0))throw new a.Error("can't assemble Target - color format is not renderable")}},this._validate=function(){var b=this._gl;a.checkGLFramebufferStatus(b,"can't assemble Target"),a.checkGLError(b,"can't assemble Target")},this._clear=function(b,c,d){var e=this._gl,f=e.COLOR_BUFFER_BIT,g=this._depth&&this._depth.format();e.clearColor(b.r,b.g,b.b,b.a),g&&(e.clearDepth(c),f|=e.DEPTH_BUFFER_BIT,g===a.Format.DEPTH_STENCIL&&(e.clearStencil(d),f|=e.STENCIL_BUFFER_BIT)),e.clear(f)},this._write=function(b,c,d){var e=this._gl,f=this._depth&&this._depth.format();a.applyColorMask(e,b),f&&(e.depthMask(c),f===a.Format.DEPTH_STENCIL&&e.stencilMask(d))},this._restore=function(){this._make(this._color,this._depth)}},B.Render.Target=function(a,b,c,d,e){this._device=a,this._width=0,this._height=0,this._size=B.Math.makeVector2(),this._multisamples=0,this._color=[],this._depth=null,this._gl=a._gl,this._glFramebuffer=null,this._id=-1,this._make(b,c,d,e)},B.Render.Target.prototype=new B.Render.TargetProto,B.Render.Uniform={FLOAT:1,VECTOR2:2,VECTOR3:3,VECTOR4:4,MATRIX3:5,MATRIX4:6,SAMPLER_2D:7,SAMPLER_CUBE:8},B.Render.uniformByteSize=function(a){var b=B.Render.Uniform;switch(a){case b.FLOAT:return 4;case b.VECTOR2:return 8;case b.VECTOR3:return 12;case b.VECTOR4:return 16;case b.MATRIX3:return 36;case b.MATRIX4:return 64}return 0},B.Render.fromGLUniformActiveInfo=function(a,b){var c=B.Render.Uniform;switch(b.type){case a.FLOAT:return c.FLOAT;case a.FLOAT_VEC2:return c.VECTOR2;case a.FLOAT_VEC3:return c.VECTOR3;case a.FLOAT_VEC4:return c.VECTOR4;case a.FLOAT_MAT3:return c.MATRIX3;case a.FLOAT_MAT4:return c.MATRIX4;case a.SAMPLER_2D:return c.SAMPLER_2D;case a.SAMPLER_CUBE:return c.SAMPLER_CUBE}},B.Render.State={POLYGON:0,MULTISAMPLE:1,COLOR:2,DEPTH:3,STENCIL:4,BLEND:5,COUNT:6},B.Render.Face={FRONT:1,BACK:2,BOTH:3},B.Render.PolygonStateProto=function(){var a=B.Render,b=a.Face,c=function(a,b){var c=B.Render.Face;switch(b){case c.FRONT:return a.FRONT;case c.BACK:return a.BACK;case c.BOTH:return a.FRONT_AND_BACK}};this.pass=function(){return this._pass},this.default=function(){return this.cull(b.BACK),this.offset(!1),this},this.cull=function(a){var b=this._gl;return 0===arguments.length?this._cull:(this._cull=a,this._glCull=a!==!1?c(b,a):!1,this)},this.offset=function(a,b){return 0===arguments.length?this._offset:(this._offset=1===arguments.length?arguments[0]:{factor:a,units:b},this)},this._apply=function(a){var b=this._gl,c=this._offset,d=a&&a._offset;a&&a._cull===this._cull||(this._cull===!1?b.disable(b.CULL_FACE):(b.enable(b.CULL_FACE),b.cullFace(this._glCull))),a&&d===c||(c===!1?b.disable(b.POLYGON_OFFSET_FILL):b.enable(b.POLYGON_OFFSET_FILL)),c===!1||a&&c.factor===d.factor&&c.units===d.units||b.polygonOffset(c.factor,c.units)}},B.Render.PolygonState=function(a){this._cull=0,this._offset=0,this._pass=a,this._gl=a.device()._gl,this._glCull=0,this.default()},B.Render.PolygonState.prototype=new B.Render.PolygonStateProto,B.Render.MultisampleStateProto=function(){this.pass=function(){return this._pass},this.default=function(){return this.coverage(!1),this.alpha(!1),this},this.coverage=function(a,b){return 0===arguments.length?this._coverage:(this._coverage=1===arguments.length?arguments[0]:{value:a,invert:b},this)},this.alpha=function(a){return 0===arguments.length?this._alpha:(this._alpha=a,this)},this._apply=function(a){var b=this._gl,c=this._coverage,d=a&&a._coverage;a&&d===c||(c===!1?b.disable(b.SAMPLE_COVERAGE):b.enable(b.SAMPLE_COVERAGE)),c===!1||a&&c.value===d.value&&c.invert===d.invert||b.sampleCoverage(c.value,c.invert),a&&a._alpha===this._alpha||(this._alpha===!0?b.enable(b.SAMPLE_ALPHA_TO_COVERAGE):b.disable(b.SAMPLE_ALPHA_TO_COVERAGE))}},B.Render.MultisampleState=function(a){this._coverage=0,this._alpha=0,this._pass=a,this._gl=a.device()._gl,this.default()},B.Render.MultisampleState.prototype=new B.Render.MultisampleStateProto,B.Render.ColorStateProto=function(){var a=B.Render;this.pass=function(){return this._pass},this.default=function(){return this.write(a.Mask.RGBA),this},this.write=function(a){return 0===arguments.length?this._write:(this._write=a,this)},this._apply=function(b){var c=this._write;b&&b._write===c||a.applyColorMask(this._gl,c)}},B.Render.ColorState=function(a){this._write=0,this._pass=a,this._gl=a.device()._gl,this.default()},B.Render.ColorState.prototype=new B.Render.ColorStateProto,B.Render.CmpFunc={NEVER:1,ALWAYS:2,LESS:3,LESS_EQUAL:4,GREATER:5,GREATER_EQUAL:6,EQUAL:7,NOT_EQUAL:8},B.Render.toGLCmpFunc=function(a,b){var c=B.Render.CmpFunc;switch(b){case c.NEVER:return a.NEVER;case c.ALWAYS:return a.ALWAYS;case c.LESS:return a.LESS;case c.LESS_EQUAL:return a.LEQUAL;case c.GREATER:return a.GREATER;case c.GREATER_EQUAL:return a.GEQUAL;case c.EQUAL:return a.EQUAL;case c.NOT_EQUAL:return a.NOTEQUAL}},B.Render.DepthStateProto=function(){var a=B.Render,b=a.CmpFunc;this.pass=function(){return this._pass},this.default=function(){return this.test(b.LESS_EQUAL),this.write(!0),this},this.test=function(b){return 0===arguments.length?this._test:(this._test=b,this._glFunc=b&&a.toGLCmpFunc(this._gl,b),this)},this.write=function(a){return 0===arguments.length?this._write:(this._write=a,this)},this._apply=function(a){var b=this._gl,c=this._write,d=this._glFunc,e=a&&a._glFunc;a&&e===d||(d===!1?b.disable(b.DEPTH_TEST):a&&e!==!1?b.depthFunc(d):(b.enable(b.DEPTH_TEST),b.depthFunc(d))),a&&a._write===c||b.depthMask(c)}},B.Render.DepthState=function(a){this._test=0,this._write=0,this._pass=a,this._gl=a.device()._gl,this._glFunc=0,this.default()},B.Render.DepthState.prototype=new B.Render.DepthStateProto,B.Render.StencilOp={KEEP:1,ZERO:2,REPLACE:3,INCR:4,INCR_WRAP:5,DECR:6,DECR_WRAP:7,INVERT:8},B.Render.StencilStateProto=function(){var a=B.Render,b=a.StencilOp,c=function(a,c){switch(c){case b.KEEP:return a.KEEP;case b.ZERO:return a.ZERO;case b.REPLACE:return a.REPLACE;case b.INCR:return a.INCR;case b.INCR_WRAP:return a.INCR_WRAP;case b.DECR:return a.DECR;case b.DECR_WRAP:return a.DECR_WRAP;case b.INVERT:return a.INVERT}};this.pass=function(){return this._pass},this.default=function(){return this.test(!1),this.ref(0),this.mask(1),this.op(b.KEEP,b.KEEP,b.KEEP),this.write(1),this},this.test=function(b){return 0===arguments.length?this._test:(this._test=b,this._glFunc=b&&a.toGLCmpFunc(this._gl,b),this)},this.ref=function(a){return 0===arguments.length?this._ref:(this._ref=a,this)},this.mask=function(a){return 0===arguments.length?this._mask:(this._mask=a,this)},this.op=function(a,b,d){var e=this._gl;return 0===arguments.length?this._op:(1===arguments.length?this._op=arguments[0]:(this._op={failStencil:a,failDepth:b,passAll:d},this._glOp={failStencil:c(e,a),failDepth:c(e,b),passAll:c(e,d)}),this)},this.write=function(a){return 0===arguments.length?this._write:(this._write=a,this)},this._apply=function(a){var b=this._gl,c=this._glFunc,d=a&&a._glFunc,e=this._glOp,f=a&&a._glOp,g=this._write;a&&d===c||(c===!1?b.disable(b.STENCIL_TEST):a&&d!==!1?b.stencilFunc(c,this._ref,this._mask):(b.enable(b.STENCIL_TEST),b.stencilFunc(c,this._ref,this._mask))),a&&f.failStencil===e.failStencil&&f.failDepth===e.failDepth&&f.passAll===e.passAll||b.stencilOp(e.failStencil,e.failDepth,e.passAll),a&&a._write===g||b.stencilMask(g)}},B.Render.StencilState=function(a){this._enabled=0,this._test=0,this._ref=0,this._mask=0,this._op=0,this._write=0,this._pass=a,this._gl=a.device()._gl,this._glFunc=0,this._glOp=0,this.default()},B.Render.StencilState.prototype=new B.Render.StencilStateProto,B.Render.Blend={ZERO:1,ONE:2,SRC_COLOR:3,INV_SRC_COLOR:4,DEST_COLOR:5,INV_DEST_COLOR:6,SRC_ALPHA:7,INV_SRC_ALPHA:8,DEST_ALPHA:9,INV_DEST_ALPHA:10,CONST_COLOR:11,INV_CONST_COLOR:12,CONST_ALPHA:13,INV_CONST_ALPHA:14,SRC_ALPHA_SAT:15},B.Render.BlendEq={ADD:1,SUBTRACT:2,REV_SUBTRACT:3},B.Render.BlendStateProto=function(){var a=B.Math,b=B.Render,c=b.Blend,d=b.BlendEq,e=a.makeColor(0,0,0,0),f=function(a,b){switch(b){case d.ADD:return a.FUNC_ADD;case d.SUBTRACT:return a.FUNC_SUBTRACT;case d.REV_SUBTRACT:return a.FUNC_REVERSE_SUBTRACT}},g=function(a,b){var c=B.Render.Blend;switch(b){case c.ZERO:return a.ZERO;case c.ONE:return a.ONE;case c.SRC_COLOR:return a.SRC_COLOR;case c.INV_SRC_COLOR:return a.ONE_MINUS_SRC_COLOR;case c.DEST_COLOR:return a.DST_COLOR;case c.INV_DEST_COLOR:return a.ONE_MINUS_DST_COLOR;case c.SRC_ALPHA:return a.SRC_ALPHA;case c.INV_SRC_ALPHA:return a.ONE_MINUS_SRC_ALPHA;case c.DEST_ALPHA:return a.DST_ALPHA;case c.INV_DEST_ALPHA:return a.ONE_MINUS_DST_ALPHA;case c.CONST_COLOR:return a.CONSTANT_COLOR;case c.INV_CONST_COLOR:return a.ONE_MINUS_CONSTANT_COLOR;case c.CONST_ALPHA:return a.CONSTANT_ALPHA;case c.INV_CONST_ALPHA:return a.ONE_MINUS_CONSTANT_ALPHA;case c.SRC_ALPHA_SAT:return a.SRC_ALPHA_SATURATE}};this.pass=function(){return this._pass},this.default=function(){return this.const(e),this.src(c.ONE),this.dest(c.ZERO),this.eq(d.ADD),this.enabled(!1),this},this.enabled=function(a){return 0===arguments.length?this._enabled:(this._enabled=a,this)},this.const=function(a){return 0===arguments.length?this._const:(this._const.copy(a),this)},this.src=function(a){var b=this._gl;return 0===arguments.length?this._src:(this._src=a,this._glSrc=g(b,a),this)},this.dest=function(a){var b=this._gl;return 0===arguments.length?this._dest:(this._dest=a,this._glDest=g(b,a),this)},this.eq=function(a){var b=this._gl;return 0===arguments.length?this._eq:(this._eq=a,this._glEq=f(b,a),this)},this._apply=function(a){var b=this._gl,c=this._const,d=this._enabled,e=this._glEq,f=a&&a._glEq,g=this._glSrc,h=a&&a._glSrc,i=this._glDest,j=a&&a._glDest;a&&a._enabled===d||(d?b.disable(b.BLEND):b.enable(b.BLEND)),a&&a._const.equal(c)||b.blendColor(c.r,c.g,c.b,c.a),a&&f===e||b.blendEquation(e),a&&h===g&&j===i||b.blendFunc(g,i)}},B.Render.BlendState=function(a){this._const=B.Math.makeColor(),this._src=0,this._dest=0,this._eq=0,this._pass=a,this._gl=a.device()._gl,this._glEq=0,this._glSrc=0,this._glDest=0,this.default()},B.Render.BlendState.prototype=new B.Render.BlendStateProto,B.Render.Address={WRAP:1,MIRROR:2,CLAMP:3},B.Render.Filter={NONE:1,BILINEAR:2,TRILINEAR:3},B.Render.SamplerProto=function(){var a=B.Render,b=a.Filter,c=a.Address,d=function(a,b){switch(b){case c.WRAP:return a.REPEAT;case c.MIRROR:return a.MIRRORED_REPEAT;case c.CLAMP:return a.CLAMP_TO_EDGE}};this.pass=function(){return this._pass},this.default=function(){return this.address(c.WRAP),this.filter(b.BILINEAR),this},this.address=function(a,b){var c=this._gl,e=this._address;return 0===arguments.length?e:(e.u=a,e.v=1===arguments.length?a:b,this._glWrapS=d(c,e.u),this._glWrapT=d(c,e.v),this)},this.filter=function(a){var c=this._gl;if(0===arguments.length)return this._filter;switch(this._filter=a,this._filter){case b.NONE:this._glMagFilter=c.NEAREST,this._glMinFilter[0]=c.NEAREST,this._glMinFilter[1]=c.NEAREST;break;case b.BILINEAR:this._glMagFilter=c.LINEAR,this._glMinFilter[0]=c.LINEAR,this._glMinFilter[1]=c.LINEAR_MIPMAP_NEAREST;break;case b.TRILINEAR:this._glMagFilter=c.LINEAR,this._glMinFilter[0]=c.LINEAR,this._glMinFilter[1]=c.LINEAR_MIPMAP_LINEAR}return this},this.anisotropy=function(a){var b=this._device.caps();return 0===arguments.length?this._anisotropy:(this._anisotropy=Math.max(1,Math.min(a,b.samplerAnisotropy?b.samplerMaxAnisotropy:1)),this)},this._apply=function(b,c,d,e){var f=this._gl,g=this._device._ext("texture_filter_anisotropic"),h=null,i=0;if(e instanceof a.Texture)h=e._glTexture,i=e.mipCount()>1?1:0;else if(e instanceof a.Mip)e=e.texture(),h=e._glTexture,i=e.mipCount()>1?1:0;else if(e instanceof a.Depth){if(!this._device.caps().readableDepth)throw new a.Error("reading from the depth buffer is not supported (check device.caps().readableDepth)");if(!e.readable())throw new a.Error("depth buffer wasn't created readable");h=e._glHandle}f.activeTexture(f.TEXTURE0+d),f.bindTexture(b,h),h&&(f.texParameteri(b,f.TEXTURE_MAG_FILTER,this._glMagFilter),f.texParameteri(b,f.TEXTURE_MIN_FILTER,this._glMinFilter[i]),f.texParameteri(b,f.TEXTURE_WRAP_S,this._glWrapS),f.texParameteri(b,f.TEXTURE_WRAP_T,this._glWrapT),g&&f.texParameteri(b,g.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)),f.uniform1i(c,d)}},B.Render.Sampler=function(a){this._pass=a,this._device=a.device(),this._filter=0,this._anisotropy=1,this._address={u:0,v:0},this._gl=a.device()._gl,this._glWrapS=0,this._glWrapT=0,this._glMagFilter=0,this._glMinFilter=[0,0],this.default()},B.Render.Sampler.prototype=new B.Render.SamplerProto,B.Render.Shader={VERTEX:0,FRAGMENT:1,COUNT:2},B.Render.PassProto=function(){var a=B.Math,b=B.Render,c=function(a,c){switch(c){case b.Shader.VERTEX:return a.VERTEX_SHADER;case b.Shader.FRAGMENT:return a.FRAGMENT_SHADER}};this.device=function(){return this._device},this.attributes=function(){return this._attributes},this.uniforms=function(){return this._uniforms},this.sampler=function(a){var c=this._samplers,d=c[a];return d||(d=new b.Sampler(this),c[a]=d),d},this.state=function(a){return this._states[a]||null},this.compile=function(){var a=b.Uniform,d=function(a,b){var c,d=a._macros,e="";for(c in d)e+="#define "+c+" "+d[c]+"\n";return e+"#line 0\n"+b},e=function(){var a=/#extension\s+GL_OES_standard_derivatives\s*:/g,c=/(?:\s+|;)(?:(?:dFdx\s*\()|(?:dFdy\s*\()|(?:fwidth\s*\())/g,d=/#extension\s+GL_EXT_frag_depth\s*:/g,e=/(?:\s+|;)gl_FragDepthEXT\s*=/g,f=/#extension\s+GL_EXT_draw_buffers\s*:/g,g=/(?:\s+|;)gl_FragData\s*\[\s*(\d+)\s*\]/g;return function(h,i,j){var k,l=h._device.caps(),m="";if(i===b.Shader.FRAGMENT&&(l.derivatives===!0&&j.match(c)&&!j.match(a)&&(m+="#extension GL_OES_standard_derivatives : enable\n"),l.writableDepth===!0&&j.match(e)&&!j.match(d)&&(m+="#extension GL_EXT_frag_depth : enable\n"),l.colorTargetCount>1&&!j.match(f)))do if(k=g.exec(j),k&&k[1]>0){m+="#extension GL_EXT_draw_buffers : enable\n";break}while(k);return m+"#line 0\n"+j}}(),f=function(){var a=/precision\s+(\w+)\s+float\s*;/g,b=function(a,b){var d=c(a,b);return a.getShaderPrecisionFormat(d,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(d,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp"};return function(c,d,e){return e.match(a)?e:"precision "+b(c._gl,d)+" float;\n#line 0\n"+e}}(),g=function(){var b=["x","y","z","w"],c=function(b){switch(b){case"float":return a.FLOAT;case"vec2":return a.VECTOR2;case"vec3":return a.VECTOR3;case"vec4":return a.VECTOR4;case"mat3":return a.MATRIX3;case"mat4":return a.MATRIX4}},d=function(c,d,e,f){var g;switch(c){case a.FLOAT:g=f+"["+d+"]."+b[e];break;case a.VECTOR2:g=f+"["+d+"]."+b[e]+b[e+1];break;case a.VECTOR3:g=f+"["+d+"].xyz";break;case a.VECTOR4:g=f+"["+d+"]";break;case a.MATRIX3:g=f+"["+d+"].xyz,"+f+"["+(d+1)+"].xyz,"+f+"["+(d+2)+"].xyz";break;case a.MATRIX4:g=f+"["+d+"],"+f+"["+(d+1)+"],"+f+"["+(d+2)+"],"+f+"["+(d+3)+"]"}return g},e=function(a,b,e,f){var g=c(a),h=e.register,i=e.component;return a+" "+b+" = "+a+"("+d(g,h,i,f)+");"},f=/uniform\s+(\w+)\s+(\w+)\s*(?:\[\s*(\d+|\s+)\s*\])?\s*;/g,g=null,h=!1,i=function(a,b,c,d){var f=g.name,i=g.registers,j=g.mapping[c],k=a;return j&&!d&&(k=e(b,c,j,f),h||(k="uniform vec4 "+f+"["+i+"];"+k,h=!0)),k};return function(a,b){return g=a._uniformBuffer,h=!1,b.replace(f,i)}}(),h=function(a,c,h){var i,j=a._gl,k=a._glShaders[c];if(!h||!h.length)throw new b.Error("can't compile Pass - invalid source code");if(h=d(a,h),h=e(a,c,h),h=f(a,c,h),null!==a._uniformBuffer&&(h=g(a,h)),j.shaderSource(k,h),j.compileShader(k),!j.getShaderParameter(k,j.COMPILE_STATUS))throw i=j.getShaderInfoLog(k),i?new b.Pass.CompileError("can't compile Pass",c,i):new b.Error("can't compile Pass - internal error");return h},i=function(a,c,d){var e,f,g=d||[];for(e=0,f=b.Shader.COUNT;f>e;e+=1)g[e]=h(a,e,c[e])},j=function(a){var c,d,e=a._gl,f=a._glProgram;for(c=0,d=b.Shader.COUNT;d>c;c+=1)e.attachShader(f,a._glShaders[c]);if(e.linkProgram(f),!e.getProgramParameter(f,e.LINK_STATUS))throw new b.Error("can't compile Pass - "+(e.getProgramInfoLog(f)||"internal error"))},k=function(a){var c,d,e=a._gl,f=a._glProgram;for(c=0,d=b.Shader.COUNT;d>c;c+=1)e.detachShader(f,a._glShaders[c])},l=function(a){var c,d,e,f,g,h=a._gl,i=a._glProgram,j=h.getProgramParameter(i,h.ACTIVE_ATTRIBUTES);for(a._attributes={},a._glAttributes={},c=0;j>c;c+=1)d=h.getActiveAttrib(i,c),e=d.name,f=b.fromGLAttributeActiveInfo(h,d),g=h.getAttribLocation(i,e),-1!==g&&(a._attributes[e]=f,a._glAttributes[e]={type:f,location:g})},m=function(a){var c,d,e,f,g,h,i=a._gl,j=a._glProgram,k=i.getProgramParameter(j,i.ACTIVE_UNIFORMS);for(a._uniforms={},a._glUniforms={},c=0;k>c;c+=1){if(d=i.getActiveUniform(j,c),h=d.name.search("[0]"),e=-1!==h?d.name.slice(0,h-1):d.name,f=b.fromGLUniformActiveInfo(i,d),!f)throw new b.Error("can't compile Pass - unsupported uniform type ["+e+"]");g=i.getUniformLocation(j,d.name),g&&(a._uniforms[e]={type:f,count:d.size},a._glUniforms[e]={type:f,offset:0,location:g,value:null,array:-1!==h})}},n=function(c){var d,e,f,g=c._glUniforms,h=c._samplers,i=0;for(f in g)d=g[f],(d.type===a.SAMPLER_2D||d.type===a.SAMPLER_CUBE)&&(e=h[f],e||(h[f]=new b.Sampler(c)),d.offset=i,i+=1)},o=function(){var b=[a.MATRIX4,a.MATRIX3,a.VECTOR4,a.VECTOR3,a.VECTOR2,a.FLOAT],c=[16,12,4,4,2,1],d=4,e=function(a,b,c,e,f){var g=c%d;
return f[b]={register:(c&&c-g)/d,component:g},a.offset=c,c+e};return function(a){var f,g,h,i,j,k,l,m,n=a._glUniforms,o=0,p={};for(f=0,g=b.length;g>f;f+=1){h=b[f],i=c[f];for(j in n)k=n[j],k.type!==h||k.array||(o=e(k,j,o,i,p))}l=o%d,m=l?o+d-l:o,a._uniformBuffer=m>0?{name:"_ub",location:0,registers:m/d,data:new Float32Array(m),mapping:p}:null}}(),p=function(b){var c,d,e=b._gl,f=b._uniformBuffer,g=b._glUniforms;for(c in g)d=g[c],(d.array||d.type===a.SAMPLER_2D||d.type===a.SAMPLER_CUBE)&&(d.location=e.getUniformLocation(b._glProgram,c));null!==f&&(f.location=e.getUniformLocation(b._glProgram,f.name))};return function(a,c,d){var e=this._shaders.source,f=this._shaders.translated;return e[b.Shader.VERTEX]=a,e[b.Shader.FRAGMENT]=c,this._macros=d||{},this._uniformBuffer=null,i(this,e),j(this),l(this),m(this),n(this),k(this),o(this),i(this,e,f),j(this),p(this),this}}(),this.source=function(a,b){var c=this._shaders;return(b?c.translated[a]:c.source[a])||null},this.free=function(){var a,c,d,e=this._gl,f=this._glShaders,g=this._samplers,h=this._states;for(this._device._removePass(this),a=0,c=b.Shader.COUNT;c>a;a+=1)e.deleteShader(f[a]);e.deleteProgram(this._glProgram);for(d in g)B.Std.freeObject(g[d]);for(a=0,c=b.State.COUNT;c>a;a+=1)B.Std.freeObject(h[a]);B.Std.freeObject(this)},this._make=function(a,c,d){var e=b.State,f=this._states;f[e.POLYGON]=new b.PolygonState(this),f[e.MULTISAMPLE]=new b.MultisampleState(this),f[e.COLOR]=new b.ColorState(this),f[e.DEPTH]=new b.DepthState(this),f[e.STENCIL]=new b.StencilState(this),f[e.BLEND]=new b.BlendState(this),this._adjust(),this.compile(a,c,d)},this._adjust=function(){var a,d,e=this._gl,f=this._glShaders;for(this._glProgram=e.createProgram(),a=0,d=b.Shader.COUNT;d>a;a+=1)f[a]=e.createShader(c(e,a));b.checkGLError(e,"can't adjust Pass")},this._begin=function(a){var c,d,e,f=this._gl,g=this._glAttributes,h=this._states;for(f.useProgram(this._glProgram),c=0,d=b.State.COUNT;d>c;c+=1)h[c]._apply(a&&a._states[c]);for(e in g)f.enableVertexAttribArray(g[e].location)},this._end=function(){var a,b=this._gl,c=this._glAttributes;for(a in c)b.disableVertexAttribArray(c[a].location)},this._uniform=function(a,b){a in this._glUniforms&&(this._glUniforms[a].value=b)},this._resetUniforms=function(){var c=b.Uniform,d=[];return d[c.FLOAT]=0,d[c.VECTOR2]=a.Vector2.ZERO,d[c.VECTOR3]=a.Vector3.ZERO,d[c.VECTOR4]=a.Vector4.ZERO,d[c.MATRIX3]=a.Matrix3.IDENTITY,d[c.MATRIX4]=a.Matrix4.IDENTITY,d[c.SAMPLER_2D]=null,d[c.SAMPLER_CUBE]=null,function(){var a,b,c=this._glUniforms;for(a in c)b=c[a],b.array||(b.value=d[b.type])}}(),this._applyUniforms=function(){var c=b.Uniform,d=function(){var b=a.makeMatrix4();return function(a,d){var e=a.type;e===c.FLOAT?d[a.offset]=a.value:e===c.MATRIX3?b.setMatrix3(a.value).toArray(d,a.offset):a.value.toArray(d,a.offset)}}(),e=function(){var a=[],b=[];return b[c.VECTOR2]=function(a,b,c){a.uniform2fv(b,c)},b[c.VECTOR3]=function(a,b,c){a.uniform3fv(b,c)},b[c.VECTOR4]=function(a,b,c){a.uniform4fv(b,c)},b[c.MATRIX3]=function(a,b,c){a.uniformMatrix3fv(b,c)},b[c.MATRIX4]=function(a,b,c){a.uniformMatrix4fv(b,c)},function(d,e){var f,g,h=d.value,i=d.offset,j=d.type;if(j===c.FLOAT)e.uniform1fv(d.location,h);else{for(a.length=0,f=0,g=h.length;g>f;f+=1)i=h[f].toArray(a,i);b[j](e,d.location,a)}}}();return function(){var a,b,f,g=this._glUniforms,h=this._samplers,i=this._uniformBuffer,j=i&&i.data,k=this._gl;for(a in g)f=g[a],b=f.type,b===c.SAMPLER_2D?h[a]._apply(k.TEXTURE_2D,f.location,f.offset,f.value):b===c.SAMPLER_CUBE?h[a]._apply(k.TEXTURE_CUBE_MAP,f.location,f.offset,f.value):f.array?f.value&&e(f,k):d(f,j);i&&k.uniform4fv(i.location,j)}}(),this._bindMesh=function(a){a._bind(this._glAttributes)},this._restore=function(){var a=this._shaders.source;this._adjust(),this.compile(a[b.Shader.VERTEX],a[b.Shader.FRAGMENT],this._macros)}},B.Render.Pass=function(a,b,c,d){this._device=a,this._shaders={source:[],translated:[]},this._macros={},this._attributes={},this._uniforms={},this._samplers={},this._states=[],this._uniformBuffer=null,this._gl=a._gl,this._glProgram=null,this._glShaders=[],this._glAttributes={},this._glUniforms={},this._id=-1,this._make(b,c,d)},B.Render.Pass.prototype=new B.Render.PassProto,B.Render.Pass.CompileErrorProto=function(){var a=/(\w+): \d+:(\d+): (.*)/,b=/ERROR\: (.+)/g;this._extract=function(c){var d,e,f,g=c.split("\n"),h=this.reasons;for(this.message+=" - "+b.exec(c)[1],d=0,e=g.length;e>d;d+=1)f=g[d].match(a),f&&h.push({type:f[1],line:parseInt(f[2],10),reason:f[3]})}},B.Render.Pass.CompileErrorProto.prototype=B.Render.Error.prototype,B.Render.Pass.CompileError=function(a,b,c){B.Render.Error.call(this,a,"B.Render.Pass.CompileError"),this.location=b,this.reasons=[],c&&this._extract(c)},B.Render.Pass.CompileError.prototype=new B.Render.Pass.CompileErrorProto,B.Render.StageProto=function(){var a=B.Render,b=a.Stage,c=b.VIEW,d=b.VIEW_INV,e=b.VIEW_POS,f=b.VIEW_DIR,g=b.PROJ,h=b.VIEW_PROJ;this.device=function(){return this._device},this.name=function(){return this._name},this.output=function(a){return 0===arguments.length?this._output:(this._output=a,this)},this.culling=function(a){return 0===arguments.length?this._culling:(this._culling=a,this._culling&&this._frustum.fromMatrix(this._viewProj),this)},this.view=function(a){return 0===arguments.length?this._view:(this._view.copy(a),this._viewInv.copy(a).invert(),this._viewInv.getAxisZ(this._viewDir).negate().normalize(),this._viewInv.getPosition(this._viewPos),this._viewProj.copy(a).mul(this._proj),this._culling&&this._frustum.fromMatrix(this._viewProj),this)},this.proj=function(a){return 0===arguments.length?this._proj:(this._proj.copy(a),this._viewProj.copy(this._view).mul(a),this._culling&&this._frustum.fromMatrix(this._viewProj),this)},this.viewProj=function(){return this._viewProj},this.viewInv=function(){return this._viewInv},this.viewPos=function(){return this._viewPos},this.viewDir=function(){return this._viewDir},this.unproject=function(){var a=B.Math,b=a.makeVector4(),c=a.makeMatrix4();return function(d,e,f){var g,h,i,j,k=f||a.makeVector3(),l=this._output,m=this._scissor,n=this._viewport;return l?m!==!1&&(d<m.x||d>m.x+m.width||e<m.y||e>m.y+m.height)?null:(n===!1?(g=0,h=0,i=l.width(),j=l.height()):(g=n.x,h=n.y,i=n.width,j=n.height),g>d||d>g+i||h>e||e>h+j?null:(b.set((d-g)/i*2-1,2*(1-(e-h)/j)-1,1,1),b.transform(c.copy(this._viewProj).invert()),k.set(b.x,b.y,b.z).mul(1/b.w))):null}}(),this.viewport=function(a,b,c,d){return 0===arguments.length?this._viewport:(this._viewport=1===arguments.length?arguments[0]:{x:a,y:b,width:c,height:d},this)},this.depthRange=function(a,b){return 0===arguments.length?this._depthRange:(this._depthRange=1===arguments.length?arguments[0]:{near:a,far:b},this)},this.scissor=function(a,b,c,d){return 0===arguments.length?this._scissor:(this._scissor=1===arguments.length?arguments[0]:{x:a,y:b,width:c,height:d},this)},this.cleanup=function(a,b,c){return 0===arguments.length?this._cleanup:(this._cleanup=1===arguments.length?arguments[0]:{color:a,depth:b,stencil:c},this)},this.write=function(a,b,c){return 0===arguments.length?this._write:(this._write={color:a,depth:b,stencil:c},this)},this.uniforms=function(){return Object.keys(this._uniforms)},this.uniform=function(a,b){return 1===arguments.length?this._uniforms[a]||null:(null===b?delete this._uniforms[a]:this._uniforms[a]=b,this)},this.before=function(a){return 0===arguments.length?this._before:(this._before=a,this)},this.after=function(a){return 0===arguments.length?this._after:(this._after=a,this)},this.free=function(){this._device._removeStage(this._name),B.Std.freeObject(this)},this._begin=function(){var a=this._device._gl,b=this._output,c=this._viewport,d=this._depthRange,e=this._scissor,f=this._cleanup,g=this._write;this._before&&this._before(this),b&&(b._bind(),c===!1?a.viewport(0,0,b.width(),b.height()):a.viewport(c.x,c.y,c.width,c.height),d===!1?a.depthRange(0,1):a.depthRange(d.near,d.far),e!==!1&&(a.enable(a.SCISSOR_TEST),a.scissor(e.x,e.y,e.width,e.height)),b._write(g.color,g.depth,g.stencil),f!==!1&&b._clear(f.color,f.depth,f.stencil))},this._end=function(){var a=this._device._gl;this._output&&this._scissor!==!1&&a.disable(a.SCISSOR_TEST),this._after&&this._after(this)},this._bindUniforms=function(a){var b,i,j=this._uniforms;for(b in j)i=j[b],i===c?i=this._view:i===d?i=this._viewInv:i===e?i=this._viewPos:i===f?i=this._viewDir:i===g?i=this._proj:i===h&&(i=this._viewProj),a._uniform(b,i)},this._isVisible=function(a){var b=a.bounds();return!this._culling||!a.culling()||b.empty()||this._frustum.contain(b)}},B.Render.Stage=function(a,b){var c=B.Math,d=B.Render;this._device=a,this._name=b,this._output=null,this._culling=!0,this._frustum=c.makeFrustum(),this._view=c.makeMatrix4(),this._proj=c.makeMatrix4(),this._viewProj=c.makeMatrix4(),this._viewInv=c.makeMatrix4(),this._viewPos=c.makeVector3(),this._viewDir=c.makeVector3(),this._uniforms={},this._viewport=!1,this._depthRange=!1,this._scissor=!1,this._write={color:d.Mask.RGBA,depth:!0,stencil:1},this._cleanup={color:c.Color.WHITE.clone(),depth:1,stencil:0}},B.Render.Stage.VIEW={},B.Render.Stage.PROJ={},B.Render.Stage.VIEW_PROJ={},B.Render.Stage.VIEW_INV={},B.Render.Stage.VIEW_POS={},B.Render.Stage.VIEW_DIR={},B.Render.Stage.prototype=new B.Render.StageProto,B.Render.MaterialProto=function(){var a=B.Render;this.device=function(){return this._device},this.name=function(){return this._name},this.pass=function(){var b=function(b){return b instanceof a.Stage?b.name():b};return function(a,c){var d,e;if(1===arguments.length)return this._passes[b(a)]||null;if(Array.isArray(a))for(d=0,e=a.length;e>d;d+=1)this._passes[b(a[d])]=c;else this._passes[b(a)]=c;return this}}(),this.uniforms=function(){return Object.keys(this._uniforms)},this.uniform=function(a,b){return 1===arguments.length?this._uniforms[a]||null:(null===b?delete this._uniforms[a]:this._uniforms[a]=b,this)},this.free=function(){this._device._removeMaterial(this._name),B.Std.freeObject(this)},this._bindUniforms=function(a){var b,c=this._uniforms;for(b in c)a._uniform(b,c[b])}},B.Render.Material=function(a,b){this._device=a,this._name=b,this._passes={},this._uniforms={}},B.Render.Material.prototype=new B.Render.MaterialProto,B.Render.InstanceProto=function(){var a=B.Math,b=B.Render,c=b.Instance.TRANSFORM,d=b.Instance.NORMAL_TRANSFORM;this.device=function(){return this._device},this.mesh=function(){return this._mesh},this.material=function(){return this._material},this.bounds=function(){return this._bounds},this.culling=function(a){return 0===arguments.length?this._culling:(this._culling=a,this)},this.uniforms=function(){return Object.keys(this._uniforms)},this.uniform=function(a,b){return 1===arguments.length?this._uniforms[a]||null:(null===b?delete this._uniforms[a]:this._uniforms[a]=b,this)},this.setTransform=function(b){return this._setTransform(b||a.Matrix4.IDENTITY)},this.transform=function(){var b=a.makeMatrix4();return function(c){return 0===arguments.length?this._transform:(this._transform.mul(c instanceof a.Matrix3?b.identity().setMatrix3(c):c),this._setTransform())}}(),this.move=function(){var b=a.makeMatrix4();return function(a,c,d){return 1===arguments.length?b.translation(a.x,a.y,a.z):b.translation(a,c,d),this.transform(b)}}(),this.rotate=function(){var b=a.makeMatrix4();return function(c,d){return 1===arguments.length?(c instanceof a.Angles&&b.fromAngles(c),c instanceof a.Quaternion&&b.fromQuaternion(c)):b.rotationAxis(c,d),this.transform(b)}}(),this.scale=function(){var b=a.makeMatrix4();return function(a,c,d){return 1===arguments.length?"number"==typeof a?b.scale(a,a,a):b.scale(a.x,a.y,a.z):b.scale(a,c,d),this.transform(b)}}(),this.free=function(){this._device._removeInstance(this),B.Std.freeObject(this)},this._bindUniforms=function(a){var b,e,f=this._uniforms;for(b in f)e=f[b],e===c?e=this._transform:e===d&&(e=this._normalTransform),a._uniform(b,e)},this._setTransform=function(b){return b&&(b instanceof a.Matrix3?this._transform.identity().setMatrix3(b):this._transform.copy(b)),this._transform.getMatrix3(this._normalTransform).invert().transpose(),this._bounds.copy(this._mesh.bounds()).transform(this._transform),this}},B.Render.Instance=function(a,b,c,d,e){var f=B.Math;this._device=a,this._material=b,this._mesh=c,this._transform=d||f.makeMatrix4(),this._normalTransform=this._transform.getMatrix3().invert().transpose(),this._bounds=c.bounds().clone().transform(this._transform),this._culling=void 0!==e?e:!0,this._uniforms={},this._id=-1},B.Render.Instance.TRANSFORM={},B.Render.Instance.NORMAL_TRANSFORM={},B.Render.Instance.prototype=new B.Render.InstanceProto,B.Render.DeviceProto=function(){var a=B.Render,b=a.Device.TIME,c=a.Device.DELTA_TIME,d=function(a,b){var c,d;for(c=0,d=a.length;d>c;c+=1)if(a[c].name()===b)return c;return-1};this.makeMesh=function(){var b=new a.Mesh(this);return b._id=this._meshes.push(b)-1,b},this.makeTexture=function(b,c,d,e,f){var g=new a.Texture(this,b,c,d,e,f);return g._id=this._textures.push(g)-1,g},this.makeDepth=function(b,c,d,e){var f=new a.Depth(this,b,c,d,e);return f._id=this._depths.push(f)-1,f},this.makeTarget=function(b,c,d,e){var f=new a.Target(this,b,c,d,e);return f._id=this._targets.push(f)-1,f},this.makePass=function(b,c,d){var e=new a.Pass(this,b,c,d);return e._id=this._passes.push(e)-1,e},this.stage=function(b,c){var e,f=this._grid.stages,g=d(f,b),h=null;return-1!==g?f[g]:(arguments.length>1&&(h=d(f,c)),e=new a.Stage(this,b),f.splice(null!==h?h:f.length,0,e),e)},this.stages=function(){var a=[];return function(){var b,c,d=this._grid.stages;for(a.length=0,b=0,c=d.length;c>b;b+=1)a[b]=d[b].name();return a}}(),this.material=function(b,c){var e,f=this._grid.materials,g=d(f,b),h=null;return-1!==g?f[g]:(arguments.length>1&&(h=d(f,c)),h=null!==h?h:f.length,e=new a.Material(this,b),f.splice(h,0,e),this._bins[b]=[],e)},this.materials=function(){var a=[];return function(){var b,c,d=this._grid.materials;for(a.length=0,b=0,c=d.length;c>b;b+=1)a[b]=d[b].name();return a}}(),this.instance=function(b,c,e,f){var g,h=this._grid.materials,i=b instanceof a.Material?b.name():b,j=d(h,i);if(-1===j)throw new a.Error("can't add Instance to Device - the material is not found");return g=new a.Instance(this,h[j],c,e,f),g._id=this._bins[i].push(g)-1,g},this.uniforms=function(){return Object.keys(this._uniforms)},this.uniform=function(a,b){return 1===arguments.length?this._uniforms[a]||null:(null===b?delete this._uniforms[a]:this._uniforms[a]=b,this)},this.frame=function(){var b=function(a,b){return b.mesh()._id-a.mesh()._id},c=function(a){var b=a._canvas,c=b.clientWidth,d=b.clientHeight;(b.width!==c||b.height!==d)&&(b.width=c,b.height=d,a._target._resize(c,d),a.trigger("resize",{width:c,height:d}))},d=function(a){var b=a._frameInfo;b.vertexDrawn=0,b.vertexTotal=0,b.primitiveDrawn=0,b.primitiveTotal=0,b.instanceDrawn=0,b.instanceTotal=0},e=function(a){var b,c,d,e,g,h,i,j,k=a._grid.stages,l=a._grid.materials,m=a._bins,n=null;for(b=0,c=k.length;c>b;b+=1){for(d=k[b],d._begin(),e=0,g=l.length;g>e;e+=1)h=l[e],i=m[h.name()],j=h.pass(d.name()),j&&i.length>0&&(n!==j&&(n&&n._end(),j._begin(n),n=j),f(a,i,h,d,j));d._end()}n&&n._end()},f=function(){var a=[];return function(c,d,e,f,h){var i,j,k,l,m=0,n=c._frameInfo;for(a.length=0,i=0,j=d.length;j>i;i+=1)l=d[i],k=l.mesh(),n.vertexTotal+=k.vertexCount(),n.primitiveTotal+=k.primitiveCount(),n.instanceTotal+=1,f._isVisible(l)&&(a[m]=l,m+=1,n.vertexDrawn+=k.vertexCount(),n.primitiveDrawn+=k.primitiveCount(),n.instanceDrawn+=1);a.sort(b),g(c,a,e,f,h)}}(),g=function(a,b,c,d,e){var f,g,h,i,j,k=-1;for(f=0,g=b.length;g>f;f+=1)i=b[f],h=i.mesh(),j=h._id,e._resetUniforms(),a._bindUniforms(e),d._bindUniforms(e),c._bindUniforms(e),i._bindUniforms(e),e._applyUniforms(),k!==j&&(k=j,e._bindMesh(h)),h._draw()},h=function(){var a=.5;return function(b){var c=Date.now(),d=(c-b._time)/1e3;b._time=c,b._deltaTime=d,b._intervalTime+=d,b._wrappedTime=(b._wrappedTime+d)%1,b._frameCount+=1,b._intervalTime>=a&&(b._frameInfo.fps=b._frameCount/b._intervalTime,b._intervalTime=0,b._frameCount=0)}}();return function(){return d(this),this._lost||(c(this),e(this),a.checkGLError(this._gl,"can't make frame")),h(this),this._frameInfo}}(),this.target=function(){return this._target},this.canvas=function(){return this._canvas},this.caps=function(){return this._caps},this.free=function(){var a=function(a){a.free()};return function(){this._meshes.forEach(a),this._textures.forEach(a),this._depths.forEach(a),this._targets.forEach(a),this._passes.forEach(a),this._grid.stages.forEach(a),this._grid.materials.forEach(a),this._canvas.removeEventListener("webglcontextlost",this._onLose,!1),this._canvas.removeEventListener("webglcontextrestored",this._onRestore,!1),B.Std.freeObject(this)}}(),this._bindUniforms=function(a){var d,e,f=this._uniforms;for(d in f)e=f[d],e===b?e=this._wrappedTime:e===c&&(e=this._deltaTime),a._uniform(d,e)},this._removeMesh=function(a){B.Std.removeUnordered(this._meshes,a._id)},this._removeTexture=function(a){B.Std.removeUnordered(this._textures,a._id)},this._removeDepth=function(a){B.Std.removeUnordered(this._depths,a._id)},this._removeTarget=function(a){B.Std.removeUnordered(this._targets,a._id)},this._removePass=function(a){B.Std.removeUnordered(this._passes,a._id)},this._removeStage=function(a){var b=this._grid.stages,c=d(b,a);b.splice(c,1)},this._removeMaterial=function(){var a=function(a){a.free()};return function(b){var c=this._grid.materials,e=this._bins,f=d(c,b);e[b].forEach(a),delete e[b],c.splice(f,1)}}(),this._removeInstance=function(a){var b=this._bins,c=b[a.material().name()];B.Std.removeUnordered(c,a._id)},this._lose=function(){this._lost=!0,this.trigger("lose")},this._restore=function(){var a=function(a){a._restore()};return function(){this._initExts(),this._initCaps(),this._meshes.forEach(a),this._textures.forEach(a),this._depths.forEach(a),this._targets.forEach(a),this._passes.forEach(a),this._lost=!1,this.trigger("restore")}}(),this._initExts=function(){var a=this._gl,b=this._exts;b.compressed_texture_s3tc=a.getExtension("WEBGL_compressed_texture_s3tc")||a.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||a.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),b.depth_texture=a.getExtension("WEBGL_depth_texture")||a.getExtension("WEBKIT_WEBGL_depth_texture")||a.getExtension("MOZ_WEBGL_depth_texture"),b.texture_filter_anisotropic=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),b.texture_half_float=a.getExtension("OES_texture_half_float"),b.texture_float=a.getExtension("OES_texture_float"),b.texture_half_float_linear=a.getExtension("OES_texture_half_float_linear"),b.texture_float_linear=a.getExtension("OES_texture_float_linear"),b.color_buffer_half_float=a.getExtension("EXT_color_buffer_half_float"),b.color_buffer_float=a.getExtension("WEBGL_color_buffer_float"),b.draw_buffers=a.getExtension("WEBGL_draw_buffers"),b.element_index_uint=a.getExtension("OES_element_index_uint"),b.standard_derivatives=a.getExtension("OES_standard_derivatives"),b.frag_depth=a.getExtension("EXT_frag_depth")},this._initCaps=function(){var a=this._gl,b=this._caps,c=this._exts,d=c.draw_buffers,e=c.texture_filter_anisotropic;b.indexUInt=!!c.element_index_uint,b.textureMaxSize=a.getParameter(a.MAX_TEXTURE_SIZE),b.cubemapMaxSize=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE),b.depthMaxSize=a.getParameter(a.MAX_RENDERBUFFER_SIZE),b.textureDXT=!!c.compressed_texture_s3tc,b.textureFloat16=!!c.texture_half_float,b.textureFloat32=!!c.texture_float,b.textureFloat16Filter=!!c.texture_half_float_linear,b.textureFloat32Filter=!!c.texture_float_linear,b.colorTargetFloat16=!!c.color_buffer_half_float,b.colorTargetFloat32=!!c.color_buffer_float,b.colorTargetCount=d?a.getParameter(d.MAX_COLOR_ATTACHMENTS_WEBGL):1,b.samplerAnisotropy=!!e,b.samplerMaxAnisotropy=e?a.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,b.readableDepth=!!c.depth_texture,b.writableDepth=!!c.frag_depth,b.derivatives=!!c.standard_derivatives,b.attributeCount=a.getParameter(a.MAX_VERTEX_ATTRIBS),b.varyingCount=a.getParameter(a.MAX_VARYING_VECTORS),b.vertexUniformCount=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS),b.vertexTextureCount=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS),b.fragmentUniformCount=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS),b.fragmentTextureCount=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS)},this._make=function(){var b=a.Format,c=function(c,d){if(c!==b.RGB&&c!==b.RGBA)throw new a.Error("can't make Device.Target - unsupported color format");if(d&&d!==b.DEPTH&&d!==b.DEPTH_STENCIL)throw new a.Error("can't make Device.Target - unsupported depth format")},d=function(a){var b=a.clientWidth,c=a.clientHeight;(a.width!==b||a.height!==c)&&(a.width=b,a.height=c)},e=function(c,d,e,f){var g=c._canvas;f.alpha=d===b.RGBA,f.depth=!!e,f.stencil=e===b.DEPTH_STENCIL;try{c._gl=g.getContext("webgl",f)||g.getContext("experimental-webgl",f)}catch(h){}if(!c._gl)throw new a.Error("can't make Device - WebGL is not supported");g.addEventListener("webglcontextlost",c._onLose,!1),g.addEventListener("webglcontextrestored",c._onRestore,!1)};return function(b,f,g){var h=this._canvas;c(b,f),d(h),e(this,b,f,g),this._initExts(),this._initCaps(),a.checkGLError(this._gl,"can't make Device"),this._target=new a.Device.Target(this,b,f,h.width,h.height),this._frameInfo={fps:0,vertexDrawn:0,vertexTotal:0,primitiveDrawn:0,primitiveTotal:0,instanceDrawn:0,instanceTotal:0}}}(),this._ext=function(a){return this._exts[a]}},B.Render.DeviceProto.prototype=new B.Std.ListenableProto,B.Render.Device=function(a,b,c,d){var e=this;B.Std.Listenable.call(this),this._canvas=a,this._gl=null,this._exts={},this._caps={},this._target=null,this._time=0,this._deltaTime=0,this._intervalTime=0,this._wrappedTime=0,this._frameCount=0,this._frameInfo=null,this._lost=!1,this._meshes=[],this._textures=[],this._depths=[],this._targets=[],this._passes=[],this._bins={},this._grid={stages:[],materials:[]},this._uniforms={},this._onLose=function(a){a.preventDefault(),e._lose()},this._onRestore=function(){e._restore()},this._make(b||B.Render.Format.RGB,c!==!1&&(c||B.Render.Format.DEPTH),d||{})},B.Render.Device.TIME={},B.Render.Device.DELTA_TIME={},B.Render.Device.prototype=new B.Render.DeviceProto,B.Render.Device.TargetProto=function(){var a=B.Render;this.device=function(){return this._device},this.width=function(){return this._width},this.height=function(){return this._height},this.size=function(){return this._size},this.multisamples=function(){return this._multisamples},this.colorFormat=function(){return this._colorFormat},this.depthFormat=function(){return this._depthFormat},this.clone=function(b){return b=b>0?b:1,this._device.makeTarget(this._colorFormat,this._depthFormat,a.toPowerOfTwo(this._width*b),a.toPowerOfTwo(this._height*b))},this._make=function(){var a=this._gl;a.bindFramebuffer(a.FRAMEBUFFER,null),this._multisamples=a.getParameter(a.SAMPLES)},this._bind=function(){var a=this._gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},this._clear=function(b,c,d){var e=this._gl,f=this._depthFormat,g=e.COLOR_BUFFER_BIT;e.clearColor(b.r,b.g,b.b,b.a),(f===a.Format.DEPTH||f===a.Format.DEPTH_STENCIL)&&(e.clearDepth(c),g|=e.DEPTH_BUFFER_BIT),f===a.Format.DEPTH_STENCIL&&(e.clearStencil(d),g|=e.STENCIL_BUFFER_BIT),e.clear(g)},this._write=function(b,c,d){var e=this._gl,f=this._depthFormat;a.applyColorMask(e,b),(f===a.Format.DEPTH||f===a.Format.DEPTH_STENCIL)&&e.depthMask(c),f===a.Format.DEPTH_STENCIL&&e.stencilMask(d)},this._resize=function(a,b){this._width=a,this._height=b,this._size.set(a,b)}},B.Render.Device.Target=function(a,b,c,d,e){this._device=a,this._width=d,this._height=e,this._size=B.Math.makeVector2(d,e),this._multisamples=0,this._colorFormat=b,this._depthFormat=c,this._gl=a._gl,this._make()},B.Render.Device.Target.prototype=new B.Render.Device.TargetProto;
//# sourceMappingURL=b.min.js.map